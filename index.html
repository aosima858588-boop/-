<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>æµ·è±šæ¨¡å‹ Â· å…¨å±€æ•°æ®é¢æ¿+å®æ—¶å˜åŒ–</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; margin: 0; padding: 0; }
        body { background: #0b0e14; display: flex; justify-content: center; padding: 16px; }
        .container { max-width: 500px; width: 100%; background: #121722; border-radius: 40px; padding: 20px 16px; box-shadow: 0 20px 30px #00000080; border: 1px solid #2f3a4a; }
        h2 { color: #dce5ff; font-weight: 600; font-size: 22px; display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .sub { color: #98a9c9; font-size: 14px; margin-bottom: 24px; border-left: 4px solid #4c9aff; padding-left: 12px; }
        .card { background: #1c2532; border-radius: 28px; padding: 18px 16px; margin-bottom: 20px; border: 1px solid #2e3c50; }
        .card-title { color: #b6ccff; font-weight: 500; margin-bottom: 16px; display: flex; align-items: center; gap: 6px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .metric-item { background: #0f1621; border-radius: 20px; padding: 12px; transition: 0.2s; }
        .metric-item.highlight { background: #1e3347; border: 1px solid #4c9aff; }
        .metric-label { color: #90a0c2; font-size: 12px; display: flex; align-items: center; gap: 4px; }
        .metric-value { color: white; font-size: 20px; font-weight: 600; }
        .metric-detail { color: #a0b5d8; font-size: 12px; }
        .change-indicator { font-size: 11px; margin-left: 8px; padding: 2px 6px; border-radius: 20px; background: #1d2a3a; }
        .change-up { color: #8affb8; }
        .change-down { color: #ff8a8a; }
        .danger { color: #ff8a8a; }
        .safe { color: #8affb8; }
        hr { border: 0.5px solid #293544; margin: 16px 0; }
        .slider-group { margin: 16px 0; }
        .slider-label { display: flex; justify-content: space-between; color: #c0d0f0; font-size: 14px; }
        input[type=range] { width: 100%; margin: 8px 0; background: #2e3c4e; height: 6px; border-radius: 20px; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; background: white; border-radius: 50%; border: 2px solid #4c9aff; cursor: pointer; }
        .btn-group { display: flex; gap: 12px; margin: 24px 0 12px; }
        .btn { background: #2e405b; border: none; color: white; padding: 14px 0; border-radius: 40px; font-weight: 600; flex: 1; font-size: 16px; transition: 0.2s; border: 1px solid #4a6180; }
        .btn.primary { background: #4c9aff; color: black; border: none; }
        .btn:active { opacity: 0.7; }
        .log-box { background: #0b111a; border-radius: 20px; padding: 14px; max-height: 200px; overflow-y: auto; font-size: 12px; color: #b8c8ec; border: 1px solid #2f3d54; margin-top: 10px; }
        .log-entry { border-bottom: 1px dashed #2d3848; padding: 5px 0; font-family: monospace; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .warning-badge { background: #4f2f2f; color: #ffbaba; border-radius: 30px; padding: 6px 14px; font-size: 13px; }
        .chart-container { height: 150px; margin: 16px 0; }
        .highlight-value { color: #ffd966; font-weight: 700; }
        .blink { background: #2a4055; transition: background 0.3s; }
    </style>
</head>
<body>
<div class="container">
    <h2>ğŸ¬ æµ·è±šæ¨¡å‹ Â· å…¨å±€æ•°æ®é¢æ¿</h2>
    <div class="sub">å®æ—¶è¿½è¸ªä»·æ ¼/äº¤æ˜“é‡/è´¨æŠ¼/æ± å­/é’±åŒ…/çŸ¿æ± </div>

    <!-- å½“å‰çŠ¶æ€å¡ç‰‡ (æ‰€æœ‰åŠ¨æ€å˜é‡ + å½“æ—¥å˜åŒ–) -->
    <div class="card">
        <div class="card-title"><span>ğŸ“Š å…¨å±€çŠ¶æ€</span> <span id="dayDisplay" style="margin-left:auto; font-size:14px;">ç¬¬0å¤©</span></div>
        
        <!-- ç¬¬ä¸€è¡Œï¼šä»·æ ¼ + äº¤æ˜“é‡ -->
        <div class="grid-2">
            <div class="metric-item highlight" id="priceBox">
                <div class="metric-label">ğŸ’° Hä»·æ ¼</div>
                <div class="metric-value" id="priceDisplay">$0.02205</div>
                <div class="metric-detail" id="redlineDist">è·çº¢çº¿ +267%</div>
            </div>
            <div class="metric-item" id="volumeBox">
                <div class="metric-label">ğŸ“Š ä»Šæ—¥äº¤æ˜“é‡</div>
                <div class="metric-value" id="volumeDisplay">0 U</div>
                <div class="metric-detail" id="netVolume">å‡€æˆäº¤: 0 U</div>
                <div class="metric-detail" id="dailyVolumeChange" style="color:#8affb8;"></div>
            </div>
        </div>

        <!-- ç¬¬äºŒè¡Œï¼šè´¨æŠ¼æ€»é‡ + æµåŠ¨æ€§æ±  -->
        <div class="grid-2">
            <div class="metric-item highlight" id="stakedBox">
                <div class="metric-label">ğŸ”’ è´¨æŠ¼æ€»é‡ H_staked</div>
                <div class="metric-value" id="stakedDisplay">8.66M</div>
                <div class="metric-detail" id="stakedChange">ä»Šæ—¥å˜åŒ–: <span id="stakedDelta">0</span> H</div>
                <div class="metric-detail">å æ± å­ <span id="stakeRatio">91%</span></div>
            </div>
            <div class="metric-item">
                <div class="metric-label">ğŸ’§ æµåŠ¨æ€§æ± </div>
                <div class="metric-value" id="lpHDisplay">9.52M H</div>
                <div class="metric-detail" id="lpUDisplay">210k U</div>
                <div class="metric-detail" id="lpChange">Hå˜åŒ–: <span id="lpHDelta">0</span> | Uå˜åŒ–: <span id="lpUDelta">0</span></div>
            </div>
        </div>

        <!-- ç¬¬ä¸‰è¡Œï¼šç¤¾åŒºé’±åŒ… + å›½åº“ + çŸ¿æ±  -->
        <div class="grid-3">
            <div class="metric-item">
                <div class="metric-label">ğŸ‘› ç¤¾åŒºé’±åŒ…</div>
                <div class="metric-value" id="communityUDisplay">20k U</div>
                <div class="metric-detail" id="communityHDisplay">500M H</div>
                <div class="metric-detail" id="communityChange">Uå˜åŒ–: <span id="communityUDelta">0</span></div>
            </div>
            <div class="metric-item">
                <div class="metric-label">ğŸ¦ å›½åº“</div>
                <div class="metric-value" id="treasuryDisplay">5,340 U</div>
                <div class="metric-detail" id="treasuryChange">ä»Šæ—¥å˜åŒ–: <span id="treasuryDelta">0</span> U</div>
            </div>
            <div class="metric-item">
                <div class="metric-label">â›ï¸ çŸ¿æ±  (æ”¶ç›Šå‚¨å¤‡)</div>
                <div class="metric-value" id="rewardDisplay">300M H</div>
                <div class="metric-detail" id="rewardChange">ä»Šæ—¥å˜åŒ–: <span id="rewardDelta">0</span> H</div>
                <div class="metric-detail">å¯æ”¯ä»˜ <span id="rewardDays">6615</span> å¤©</div>
            </div>
        </div>

        <div class="flex-between" style="margin-top:12px;">
            <span class="warning-badge" id="warningMsg">ğŸŸ¢ ä»·æ ¼å®‰å…¨</span>
            <span id="triggerCount">å›è´­è§¦å‘:0æ¬¡</span>
        </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="card">
        <div class="card-title">âš™ï¸ æ¯æ—¥å¸‚åœºå‚æ•°</div>
        <div class="slider-group">
            <div class="slider-label"><span>å¤–éƒ¨å‡€ä¹°å…¥ (USDT/å¤©)</span> <span id="buyLabel">0</span></div>
            <input type="range" id="buySlider" min="-50000" max="100000" value="0" step="1000">
            <div style="color:#a0b5d0; font-size:13px;">è´Ÿå€¼ä»£è¡¨å¤–éƒ¨å‡€å–å‡º</div>
        </div>
        <div class="slider-group">
            <div class="slider-label"><span>ç”¨æˆ·è§£è´¨æŠ¼æ¯”ä¾‹ (%)</span> <span id="unstakeLabel">0%</span></div>
            <input type="range" id="unstakeSlider" min="0" max="10" value="0" step="0.1">
            <div style="color:#a0b5d0;">å½“æ—¥ä»è´¨æŠ¼æ± å–å‡ºå¹¶å–å‡ºçš„æ¯”ä¾‹ (åŸºäºç°æœ‰è´¨æŠ¼é‡)</div>
        </div>
        <div class="btn-group">
            <button class="btn" id="stepBtn">â© æ¨¡æ‹Ÿä¸€å¤© (è‡³20ç‚¹)</button>
            <button class="btn primary" id="resetBtn">âŸ² é‡ç½®åˆå§‹</button>
        </div>
        <div style="font-size:12px; color:#b0c0e0; margin-top:8px;">* é¡ºåºï¼šç™½å¤©ä¹°å–/è§£è´¨æŠ¼ â†’ 20ç‚¹å‘æ”¾æ”¶ç›Š â†’ å›½åº“/çº¢çº¿å›è´­</div>
    </div>

    <!-- äº‹ä»¶æ—¥å¿— (æ˜¾ç¤ºå…³é”®æ•°æ®å˜åŠ¨) -->
    <div class="card" style="padding: 12px;">
        <div class="flex-between">
            <span class="card-title" style="margin-bottom:0;">ğŸ“‹ äº‹ä»¶æ—¥å¿—</span>
            <button id="clearLog" style="background:none; border:none; color:#7f92bb; font-size:12px;">æ¸…ç©º</button>
        </div>
        <div class="log-box" id="logContainer">
            <div class="log-entry">ğŸ”„ åˆå§‹çŠ¶æ€åŠ è½½å®Œæˆ</div>
        </div>
    </div>

    <!-- ä»·æ ¼å›¾è¡¨ -->
    <div class="card">
        <div class="card-title">ğŸ“ˆ ä»·æ ¼å†å² (æœ€è¿‘30æ­¥)</div>
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>
        <div style="color:#8d9fd0; font-size:12px; text-align:center;">çº¢çº¿ 0.006 â€”â€” ç¤¾åŒºå›è´­æŠ¤åŸæ²³</div>
    </div>

    <div style="color:#5f72a0; font-size:11px; text-align:center; padding:10px;">* æ‰€æœ‰å˜åŒ–é‡å‡åŸºäºå½“æ—¥æ“ä½œç´¯è®¡ï¼Œé«˜äº®æ¡†ä¸ºå…³é”®æŒ‡æ ‡ã€‚</div>
</div>

<script>
    (function() {
        // ---------- å›ºå®šå‚æ•° ----------
        const REDLINE = 0.006;                // ä»·æ ¼çº¢çº¿
        const DAILY_PAYOUT_USD = 1000;         // æ¯æ—¥æ”¯ä»˜ç­‰å€¼1000Uçš„H (æ¯æ—¥20ç‚¹å‘æ”¾)
        const TREASURY_TRIGGER = 1000;          // å›½åº“ç´¯ç§¯1000Uè§¦å‘åˆ†é…
        const REPO_FROM_TREASURY = 300;         // å›½åº“æ¯æ¬¡æ‹¿300Uå›è´­
        const TO_COMMUNITY = 700;                // å›½åº“æ¯æ¬¡è½¬700Uç»™ç¤¾åŒºé’±åŒ…

        // ---------- åˆå§‹çŠ¶æ€ (åŸºäºç¬¬äºŒé˜¶æ®µå) ----------
        let H_lp = 9523809.52;                   // æµåŠ¨æ€§æ±  H
        let U_lp = 210000;                        // æµåŠ¨æ€§æ±  U
        const k = H_lp * U_lp;                     // æ’å®šä¹˜ç§¯ 2e12

        let H_staked = 8660000;                    // è´¨æŠ¼æ± ä¸­ç”¨æˆ·é”ä»“çš„H
        let H_reward = 300000000;                   // æ”¶ç›Šå‚¨å¤‡ (3äº¿)

        let treasury = 5340;                         // å›½åº“USDT (æ¥è‡ªä¹‹å‰äº¤æ˜“)
        let communityU = 20000;                       // ç¤¾åŒºé’±åŒ…USDT (ç”¨äºçº¢çº¿å›è´­)
        let communityH = 500000000;                    // ç¤¾åŒºé’±åŒ…H (æˆ˜ç•¥å‚¨å¤‡)

        // ç”¨äºè®°å½•å½“æ—¥å˜åŒ–
        let dailyVolume = 0;                           // ä»Šæ—¥ç´¯è®¡äº¤æ˜“é‡ (USDT)
        let dailyNetBuy = 0;                            // ä»Šæ—¥å‡€ä¹°å…¥ (ä¹°å…¥U - å–å‡ºU)
        let deltaH_staked = 0;                          // è´¨æŠ¼é‡ä»Šæ—¥å‡€å˜åŒ–
        let deltaH_lp = 0;                               // æµåŠ¨æ€§æ± Hä»Šæ—¥å‡€å˜åŒ–
        let deltaU_lp = 0;                               // æµåŠ¨æ€§æ± Uä»Šæ—¥å‡€å˜åŒ–
        let deltaCommunityU = 0;                          // ç¤¾åŒºUä»Šæ—¥å‡€å˜åŒ–
        let deltaTreasury = 0;                            // å›½åº“ä»Šæ—¥å‡€å˜åŒ–
        let deltaH_reward = 0;                             // çŸ¿æ± ä»Šæ—¥å‡€å˜åŒ–

        let day = 0;
        let triggerCount = 0;                          // çº¢çº¿å›è´­è§¦å‘æ¬¡æ•°
        let priceHistory = [];                           // å­˜å‚¨æœ€è¿‘ä»·æ ¼

        // DOM å…ƒç´ 
        const priceDisplay = document.getElementById('priceDisplay');
        const redlineDist = document.getElementById('redlineDist');
        const lpHDisplay = document.getElementById('lpHDisplay');
        const lpUDisplay = document.getElementById('lpUDisplay');
        const stakedDisplay = document.getElementById('stakedDisplay');
        const stakeRatio = document.getElementById('stakeRatio');
        const treasuryDisplay = document.getElementById('treasuryDisplay');
        const communityUDisplay = document.getElementById('communityUDisplay');
        const communityHDisplay = document.getElementById('communityHDisplay');
        const rewardDisplay = document.getElementById('rewardDisplay');
        const rewardDays = document.getElementById('rewardDays');
        const dayDisplay = document.getElementById('dayDisplay');
        const warningMsg = document.getElementById('warningMsg');
        const triggerCountSpan = document.getElementById('triggerCount');
        const volumeDisplay = document.getElementById('volumeDisplay');
        const netVolume = document.getElementById('netVolume');
        const dailyVolumeChange = document.getElementById('dailyVolumeChange');
        const stakedDelta = document.getElementById('stakedDelta');
        const lpHDelta = document.getElementById('lpHDelta');
        const lpUDelta = document.getElementById('lpUDelta');
        const communityUDelta = document.getElementById('communityUDelta');
        const treasuryDelta = document.getElementById('treasuryDelta');
        const rewardDelta = document.getElementById('rewardDelta');

        const buyLabel = document.getElementById('buyLabel');
        const unstakeLabel = document.getElementById('unstakeLabel');
        const buySlider = document.getElementById('buySlider');
        const unstakeSlider = document.getElementById('unstakeSlider');
        const stepBtn = document.getElementById('stepBtn');
        const resetBtn = document.getElementById('resetBtn');
        const logContainer = document.getElementById('logContainer');
        const clearLog = document.getElementById('clearLog');

        // å›¾è¡¨åˆå§‹åŒ–
        const ctx = document.getElementById('priceChart').getContext('2d');
        let priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(30).fill(''),
                datasets: [{
                    label: 'Hä»·æ ¼',
                    data: Array(30).fill(null),
                    borderColor: '#4c9aff',
                    backgroundColor: 'rgba(76,154,255,0.1)',
                    tension: 0.2,
                    pointRadius: 2,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { min: 0, grid: { color: '#2d3645' }, ticks: { color: '#9aabcc' } }, x: { display: false } },
                plugins: { legend: { display: false } }
            }
        });

        // æ—¥å¿—è¿½åŠ 
        function addLog(message) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `â±ï¸ ${new Date().toLocaleTimeString('zh-CN', {hour12: false, hour:'2-digit', minute:'2-digit', second:'2-digit'})}  ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        clearLog.addEventListener('click', ()=>{
            logContainer.innerHTML = '<div class="log-entry">ğŸ“‹ æ—¥å¿—å·²æ¸…ç©º</div>';
        });

        // æ›´æ–°æ‰€æœ‰UIæ˜¾ç¤º
        function updateUI() {
            const price = U_lp / H_lp;
            priceDisplay.innerText = '$' + price.toFixed(6);
            const dist = ((price - REDLINE) / REDLINE * 100).toFixed(1);
            redlineDist.innerText = `è·çº¢çº¿ ${price>REDLINE?'+':''}${dist}%`;
            lpHDisplay.innerText = (H_lp/1e6).toFixed(2) + 'M H';
            lpUDisplay.innerText = Math.round(U_lp).toLocaleString() + ' U';
            stakedDisplay.innerText = (H_staked/1e6).toFixed(2) + 'M H';
            const ratio = (H_staked / H_lp * 100).toFixed(1);
            stakeRatio.innerText = ratio + '%';
            if (H_staked > H_lp) stakeRatio.style.color = '#ff8a8a'; else stakeRatio.style.color = '#a0b5d8';
            treasuryDisplay.innerText = Math.round(treasury).toLocaleString() + ' U';
            communityUDisplay.innerText = Math.round(communityU).toLocaleString() + ' U';
            communityHDisplay.innerText = (communityH/1e6).toFixed(1) + 'M H';
            rewardDisplay.innerText = (H_reward/1e6).toFixed(1) + 'M H';
            const payoutH = DAILY_PAYOUT_USD / price;
            const days = Math.floor(H_reward / payoutH);
            rewardDays.innerText = days.toLocaleString();
            dayDisplay.innerText = `ç¬¬ ${day} å¤©`;
            triggerCountSpan.innerText = `å›è´­è§¦å‘: ${triggerCount} æ¬¡`;

            // äº¤æ˜“é‡æ˜¾ç¤º
            volumeDisplay.innerText = Math.round(dailyVolume).toLocaleString() + ' U';
            netVolume.innerText = `å‡€æˆäº¤: ${dailyNetBuy > 0 ? '+' : ''}${Math.round(dailyNetBuy).toLocaleString()} U`;
            if (dailyNetBuy > 0) netVolume.style.color = '#8affb8'; else if (dailyNetBuy < 0) netVolume.style.color = '#ff8a8a'; else netVolume.style.color = '#a0b5d8';
            dailyVolumeChange.innerText = `ä»Šæ—¥äº¤æ˜“é‡: +${Math.round(dailyVolume).toLocaleString()} U`;

            // å˜åŒ–é‡æ˜¾ç¤º
            stakedDelta.innerText = (deltaH_staked > 0 ? '+' : '') + Math.round(deltaH_staked).toLocaleString();
            lpHDelta.innerText = (deltaH_lp > 0 ? '+' : '') + Math.round(deltaH_lp).toLocaleString();
            lpUDelta.innerText = (deltaU_lp > 0 ? '+' : '') + Math.round(deltaU_lp).toLocaleString();
            communityUDelta.innerText = (deltaCommunityU > 0 ? '+' : '') + Math.round(deltaCommunityU).toLocaleString();
            treasuryDelta.innerText = (deltaTreasury > 0 ? '+' : '') + Math.round(deltaTreasury).toLocaleString();
            rewardDelta.innerText = (deltaH_reward > 0 ? '+' : '') + Math.round(deltaH_reward).toLocaleString();

            // çº¢çº¿é¢„è­¦
            if (price <= REDLINE) {
                warningMsg.innerHTML = 'ğŸ”´ ä»·æ ¼è§¦åŠçº¢çº¿ï¼ç¤¾åŒºå›è´­æ¿€æ´»';
                warningMsg.style.background = '#6b2f2f';
            } else {
                warningMsg.innerHTML = 'ğŸŸ¢ ä»·æ ¼å®‰å…¨';
                warningMsg.style.background = '#1e4a2e';
            }

            // æ›´æ–°å›¾è¡¨
            if (priceHistory.length >= 30) priceHistory.shift();
            priceHistory.push(price);
            priceChart.data.datasets[0].data = [...priceHistory, ...Array(30-priceHistory.length).fill(null)];
            priceChart.update();
        }

        // é‡ç½®æ¯æ—¥å˜åŒ–é‡ (æ¯å¤©å¼€å§‹å‰é‡ç½®)
        function resetDailyChanges() {
            dailyVolume = 0;
            dailyNetBuy = 0;
            deltaH_staked = 0;
            deltaH_lp = 0;
            deltaU_lp = 0;
            deltaCommunityU = 0;
            deltaTreasury = 0;
            deltaH_reward = 0;
        }

        // æ ¸å¿ƒï¼šæ‰§è¡Œä¸€å¤©çš„æ‰€æœ‰æ­¥éª¤ (é¡ºåºï¼šç™½å¤©æ“ä½œ -> 20ç‚¹æ”¶ç›Šå‘æ”¾ -> å›½åº“/çº¢çº¿å›è´­)
        function simulateDay(externalBuy, unstakePct) {
            let log = [];
            let price = U_lp / H_lp;
            log.push(`========== å¼€å§‹ç¬¬ ${day+1} å¤© (ç™½å¤©) ==========`);

            // ---------- é‡ç½®å½“æ—¥å˜åŒ– ----------
            resetDailyChanges();

            // ---------- 1. å¤„ç†å¤–éƒ¨ä¹°å– ----------
            if (Math.abs(externalBuy) > 0.01) {
                if (externalBuy > 0) {
                    // å¤–éƒ¨ä¹°å…¥
                    let buyU = externalBuy;
                    if (buyU > U_lp * 0.9) buyU = U_lp * 0.9; // é˜²æ­¢è€—å°½
                    let newU = U_lp + buyU;
                    let newH = k / newU;
                    let hOut = H_lp - newH;   // ç”¨æˆ·ä¹°å…¥çš„H
                    // è®°å½•å˜åŒ–å‰
                    let oldH_lp = H_lp;
                    let oldU_lp = U_lp;
                    let oldH_staked = H_staked;
                    // æ›´æ–°
                    H_lp = newH;
                    U_lp = newU;
                    H_staked += hOut;
                    // ç´¯è®¡å˜åŒ–
                    deltaH_lp += H_lp - oldH_lp;
                    deltaU_lp += U_lp - oldU_lp;
                    deltaH_staked += H_staked - oldH_staked;
                    // ç¨è´¹
                    let tax = buyU * 0.05;
                    let rebate = buyU * 0.0034;
                    treasury += tax + rebate;
                    deltaTreasury += tax + rebate;
                    // äº¤æ˜“é‡
                    dailyVolume += buyU;
                    dailyNetBuy += buyU;
                    log.push(`ğŸ’° å¤–éƒ¨ä¹°å…¥ ${buyU.toLocaleString()} USDTï¼Œæ¶ˆè€— H ${Math.round(hOut).toLocaleString()}ï¼Œå…¨éƒ¨è´¨æŠ¼ã€‚äº§ç”Ÿç¨è´¹ ${Math.round(tax)} USDTï¼Œè¿”ä½£ ${Math.round(rebate)} USDT`);
                } else {
                    // å¤–éƒ¨å–å‡º (è´Ÿæ•°)
                    let sellU = -externalBuy; // æœŸæœ›å–å‡ºçš„USDTä»·å€¼
                    if (sellU > U_lp * 0.9) sellU = U_lp * 0.9;
                    // è®¡ç®—éœ€è¦å–å‡ºå¤šå°‘H
                    let newU = U_lp - sellU;
                    if (newU <= 0) newU = 1;
                    let newH = k / newU;
                    let deltaH = newH - H_lp;   // å¢åŠ çš„H (ç”¨æˆ·å–å‡ºçš„)
                    // è®°å½•å˜åŒ–å‰
                    let oldH_lp = H_lp;
                    let oldU_lp = U_lp;
                    let oldH_staked = H_staked;
                    // æ›´æ–°
                    H_lp = newH;
                    U_lp = newU;
                    let actualSellH = deltaH;
                    if (actualSellH > H_staked) actualSellH = H_staked;
                    H_staked -= actualSellH;
                    // ç´¯è®¡å˜åŒ–
                    deltaH_lp += H_lp - oldH_lp;
                    deltaU_lp += U_lp - oldU_lp;
                    deltaH_staked += H_staked - oldH_staked;
                    // ç¨è´¹
                    let tax = sellU * 0.05;
                    let rebate = sellU * 0.0034;
                    treasury += tax + rebate;
                    deltaTreasury += tax + rebate;
                    // äº¤æ˜“é‡
                    dailyVolume += sellU;
                    dailyNetBuy -= sellU;
                    log.push(`ğŸ“‰ å¤–éƒ¨å–å‡º ${sellU.toLocaleString()} USDTï¼Œå–å‡º H ${Math.round(actualSellH).toLocaleString()} (ä»è´¨æŠ¼æ± æ‰£é™¤)ï¼Œäº§ç”Ÿç¨è´¹ ${Math.round(tax)} USDTï¼Œè¿”ä½£ ${Math.round(rebate)} USDT`);
                }
                price = U_lp / H_lp;
            }

            // ---------- 2. ç”¨æˆ·ä¸»åŠ¨è§£è´¨æŠ¼å–å‡º (æŒ‰æ¯”ä¾‹) ----------
            if (unstakePct > 0.001 && H_staked > 0) {
                let sellH = H_staked * (unstakePct / 100);
                // è®°å½•å˜åŒ–å‰
                let oldH_lp = H_lp;
                let oldU_lp = U_lp;
                let oldH_staked = H_staked;
                // è¿™äº›Hå…¨éƒ¨å–å‡º
                let newH = H_lp + sellH;
                let newU = k / newH;
                let receivedU = U_lp - newU;  // ç”¨æˆ·å¾—åˆ°çš„U
                // æ›´æ–°æ± å­
                H_lp = newH;
                U_lp = newU;
                H_staked -= sellH;
                // ç´¯è®¡å˜åŒ–
                deltaH_lp += H_lp - oldH_lp;
                deltaU_lp += U_lp - oldU_lp;
                deltaH_staked += H_staked - oldH_staked;
                // ç¨è´¹
                let tax = receivedU * 0.05;
                let rebate = receivedU * 0.0034;
                treasury += tax + rebate;
                deltaTreasury += tax + rebate;
                // äº¤æ˜“é‡
                dailyVolume += receivedU;
                dailyNetBuy -= receivedU; // å–å‡ºå‡å°‘å‡€ä¹°å…¥
                log.push(`ğŸ”“ ç”¨æˆ·è§£è´¨æŠ¼ ${(unstakePct).toFixed(1)}% â†’ å–å‡º H ${Math.round(sellH).toLocaleString()}ï¼Œè·å¾— ${Math.round(receivedU).toLocaleString()} USDTï¼Œç¨è´¹ ${Math.round(tax)} USDT`);
                price = U_lp / H_lp;
            }

            // ---------- 3. 20ç‚¹ï¼šæ ¹æ®å½“å‰ H_staked å‘æ”¾æ”¶ç›Š ----------
            price = U_lp / H_lp;
            let payoutH = DAILY_PAYOUT_USD / price;
            if (payoutH > H_reward) payoutH = H_reward; // ä¸å¤Ÿå°±å…¨å‘
            // è®°å½•å˜åŒ–å‰
            let oldH_staked = H_staked;
            let oldH_reward = H_reward;
            // å‘æ”¾æ”¶ç›Š
            H_reward -= payoutH;
            H_staked += payoutH;
            // ç´¯è®¡å˜åŒ–
            deltaH_staked += H_staked - oldH_staked;
            deltaH_reward += H_reward - oldH_reward;
            log.push(`ğŸ•’ 20ç‚¹æ”¶ç›Šå‘æ”¾ï¼š${DAILY_PAYOUT_USD} USDT ç­‰å€¼ â†’ ${Math.round(payoutH).toLocaleString()} H (è‡ªåŠ¨å¤æŠ•ï¼Œè´¨æŠ¼æ± å¢åŠ )`);

            // ---------- 4. å›½åº“è‡ªåŠ¨å›è´­åŠè½¬è´¦ (æ¯1000Uè§¦å‘ä¸€æ¬¡ï¼Œæ¯æ¬¡å‡€å‡1000U) ----------
            while (treasury >= TREASURY_TRIGGER) {
                // ç”¨300Uå›è´­ (ä¹°å…¥Hï¼ŒHå½’ç¤¾åŒºé’±åŒ…)
                let buyU = REPO_FROM_TREASURY; // 300
                if (buyU > U_lp * 0.9) buyU = U_lp * 0.9; // é˜²æ­¢è€—å°½
                // è®°å½•å˜åŒ–å‰
                let oldH_lp = H_lp;
                let oldU_lp = U_lp;
                let oldCommunityH = communityH;
                let oldTreasury = treasury;
                let oldCommunityU = communityU;
                // æ‰§è¡Œå›è´­
                let newU = U_lp + buyU;
                let newH = k / newU;
                let hBought = H_lp - newH;
                H_lp = newH;
                U_lp = newU;
                communityH += hBought;
                treasury -= buyU; // æ‰£300
                // ç´¯è®¡å˜åŒ–
                deltaH_lp += H_lp - oldH_lp;
                deltaU_lp += U_lp - oldU_lp;
                deltaTreasury += treasury - oldTreasury;
                // è½¬700Uåˆ°ç¤¾åŒºé’±åŒ…
                communityU += TO_COMMUNITY;
                treasury -= TO_COMMUNITY;
                deltaCommunityU += communityU - oldCommunityU;
                deltaTreasury += treasury - (oldTreasury - buyU); // ä¸¤æ¬¡æ‰£é™¤
                // å›½åº“å›è´­æœ¬èº«ä¸è®¡å…¥æ¯æ—¥äº¤æ˜“é‡
                log.push(`ğŸ¦ å›½åº“æ»¡1000Uè§¦å‘ï¼š300Uå›è´­ H ${Math.round(hBought).toLocaleString()} (å½’ç¤¾åŒº)ï¼Œ700Uè½¬å…¥ç¤¾åŒºé’±åŒ…ï¼Œå›½åº“å‰©ä½™ ${Math.round(treasury)} U`);

                price = U_lp / H_lp; // æ›´æ–°ä»·æ ¼
                // ç»§ç»­æ£€æŸ¥ï¼Œå› ä¸ºå¯èƒ½æ‰£å®Œ1000åä»â‰¥1000
            }

            // ---------- 5. ä»·æ ¼çº¢çº¿å›è´­ (ç¤¾åŒºé’±åŒ…ä¸»åŠ¨å¹²é¢„) ----------
            let repoCount = 0;
            price = U_lp / H_lp;
            while (price <= REDLINE && communityU > 1 && repoCount < 20) {
                // ç›®æ ‡ä»·æ ¼ç•¥é«˜äºçº¢çº¿ï¼Œé¿å…é¢‘ç¹è§¦å‘
                let targetPrice = REDLINE * 1.02; // 0.00612
                // è®¡ç®—éœ€è¦å¤šå°‘Uæ‰èƒ½è¾¾åˆ°ç›®æ ‡ä»·æ ¼
                let neededU = Math.sqrt(targetPrice * k) - U_lp;
                if (neededU <= 0) break;
                let buyU = Math.min(neededU, communityU);
                if (buyU < 0.001) break;
                // è®°å½•å˜åŒ–å‰
                let oldH_lp = H_lp;
                let oldU_lp = U_lp;
                let oldCommunityU = communityU;
                let oldCommunityH = communityH;
                // æ‰§è¡Œå›è´­
                let newU = U_lp + buyU;
                let newH = k / newU;
                let hBought = H_lp - newH;
                H_lp = newH;
                U_lp = newU;
                communityU -= buyU;
                communityH += hBought;
                // ç´¯è®¡å˜åŒ–
                deltaH_lp += H_lp - oldH_lp;
                deltaU_lp += U_lp - oldU_lp;
                deltaCommunityU += communityU - oldCommunityU;
                triggerCount++;
                repoCount++;
                log.push(`ğŸš¨ çº¢çº¿å›è´­ç¬¬${repoCount}æ¬¡ï¼šç¤¾åŒºé’±åŒ…èŠ±è´¹ ${Math.round(buyU)} USDT ä¹°å…¥ ${Math.round(hBought).toLocaleString()} H`);
                price = U_lp / H_lp;
                if (price > REDLINE) break;
            }
            if (repoCount > 0) {
                log.push(`âœ… çº¢çº¿å›è´­ç»“æŸï¼Œå½“å‰ä»·æ ¼ $${price.toFixed(6)}`);
            }

            day++;
            // è¾“å‡ºæ—¥å¿—åˆ°UI
            log.forEach(msg => addLog(msg));
            updateUI();
        }

        // é‡ç½®åˆ°åˆå§‹
        function reset() {
            H_lp = 9523809.52;
            U_lp = 210000;
            H_staked = 8660000;
            H_reward = 300000000;
            treasury = 5340;
            communityU = 20000;
            communityH = 500000000;
            day = 0;
            triggerCount = 0;
            priceHistory = [];
            resetDailyChanges();
            addLog('ğŸ” é‡ç½®è‡³åˆå§‹çŠ¶æ€ (ç¬¬äºŒé˜¶æ®µå)');
            updateUI();
        }

        // äº‹ä»¶ç»‘å®š
        stepBtn.addEventListener('click', ()=>{
            let buyVal = parseFloat(buySlider.value);
            let unstakeVal = parseFloat(unstakeSlider.value);
            buyLabel.innerText = buyVal;
            unstakeLabel.innerText = unstakeVal + '%';
            simulateDay(buyVal, unstakeVal);
        });

        resetBtn.addEventListener('click', ()=>{
            reset();
        });

        buySlider.addEventListener('input', ()=>{
            buyLabel.innerText = buySlider.value;
        });
        unstakeSlider.addEventListener('input', ()=>{
            unstakeLabel.innerText = unstakeSlider.value + '%';
        });

        // åˆå§‹åŒ–
        reset();
    })();
</script>
</body>
</html>
