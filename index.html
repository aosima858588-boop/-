<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ·è±šæ¨¡å‹ Â· ç¾åŒ–ç‰ˆ Â· åŠ¨æ€é«˜äº®</title>
    <!-- Font Awesome å›¾æ ‡åº“ (å¯é€‰, ç”¨äºç¾åŒ–) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #0b0f1a 0%, #141b2b 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
        }

        .container {
            max-width: 620px;
            width: 100%;
            background: rgba(18, 26, 40, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 48px;
            padding: 24px 20px;
            border: 1px solid rgba(76, 154, 255, 0.15);
            box-shadow: 0 30px 50px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255, 255, 255, 0.03) inset;
        }

        h2 {
            color: #fff;
            font-size: 28px;
            font-weight: 600;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        h2 i {
            color: #4c9aff;
            font-size: 32px;
        }

        .subtitle {
            color: #8da0cc;
            font-size: 14px;
            margin-bottom: 24px;
            border-left: 3px solid #4c9aff;
            padding-left: 14px;
            background: linear-gradient(90deg, rgba(76,154,255,0.1), transparent);
            border-radius: 0 8px 8px 0;
        }

        /* ç½‘æ ¼å¡ç‰‡å¸ƒå±€ */
        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 14px;
            margin-bottom: 18px;
        }

        .card {
            background: rgba(12, 20, 30, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 28px;
            padding: 18px 16px;
            border: 1px solid rgba(76, 154, 255, 0.12);
            box-shadow: 0 10px 20px -10px rgba(0,0,0,0.5);
            transition: transform 0.1s ease, border-color 0.2s;
        }

        .card:hover {
            border-color: rgba(76, 154, 255, 0.3);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #b0c6f0;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .card-header i {
            color: #4c9aff;
            font-size: 16px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 10px;
        }

        .data-label {
            color: #7f92bb;
            font-size: 13px;
        }

        .data-value {
            font-size: 22px;
            font-weight: 600;
            color: white;
            transition: color 0.2s, text-shadow 0.2s;
        }

        .data-detail {
            font-size: 12px;
            color: #a0b5d8;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .badge {
            background: rgba(76, 154, 255, 0.15);
            border-radius: 30px;
            padding: 4px 12px;
            font-size: 12px;
            color: #b8d0ff;
            border: 0.5px solid rgba(76,154,255,0.3);
        }

        /* åŠ¨æ€é«˜äº®é¢œè‰² */
        .value-danger { color: #ff6b6b !important; text-shadow: 0 0 8px rgba(255, 80, 80, 0.4); }
        .value-warning { color: #ffb347 !important; }
        .value-safe { color: #6bcf7f !important; }
        .value-neutral { color: white !important; }
        .value-positive { color: #6bcf7f !important; }
        .value-negative { color: #ff8a8a !important; }

        .change-up { color: #6bcf7f; }
        .change-down { color: #ff8a8a; }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4c9aff, #6fafff);
            border-radius: 10px;
            width: 0%;
        }

        hr {
            border: none;
            border-top: 1px solid rgba(76,154,255,0.15);
            margin: 18px 0;
        }

        .slider-panel {
            background: rgba(0,0,0,0.2);
            border-radius: 32px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .slider-group {
            margin-bottom: 22px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            color: #c0d0f0;
            font-size: 14px;
            margin-bottom: 6px;
        }

        input[type=range] {
            width: 100%;
            height: 8px;
            background: rgba(30, 40, 60, 0.8);
            border-radius: 20px;
            -webkit-appearance: none;
            outline: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            border: 2px solid #4c9aff;
            box-shadow: 0 4px 12px #4c9aff;
            cursor: pointer;
            transition: 0.1s;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            background: rgba(30, 45, 70, 0.9);
            border: none;
            color: white;
            padding: 16px 0;
            border-radius: 40px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(76,154,255,0.3);
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(145deg, #4c9aff, #2a6fc9);
            border: none;
            color: black;
            font-weight: 700;
            box-shadow: 0 8px 20px -8px #4c9aff;
        }

        .btn-primary:hover {
            background: linear-gradient(145deg, #5fa8ff, #3a7fd9);
            transform: scale(1.02);
        }

        .btn:hover {
            background: rgba(45, 65, 100, 0.9);
        }

        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 28px;
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            color: #b0c6e0;
            border: 1px solid rgba(76,154,255,0.15);
            margin-top: 20px;
        }

        .log-entry {
            border-bottom: 1px dashed rgba(76,154,255,0.2);
            padding: 6px 0;
            font-family: 'SF Mono', monospace;
        }

        .flex {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .glow {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* å°æ ‡ç­¾ */
        .chip {
            background: rgba(0,0,0,0.3);
            border-radius: 30px;
            padding: 2px 10px;
            font-size: 11px;
            color: #aab9e0;
        }
    </style>
</head>
<body>
<div class="container">
    <h2><i class="fas fa-dolphin"></i> æµ·è±šç»æµæ¨¡å‹</h2>
    <div class="subtitle">é˜¶æ¢¯åˆ©ç‡ Â· å›½åº“å›è´­ Â· åŠ¨æ€é«˜äº®</div>

    <!-- æ ¸å¿ƒæ•°æ®ç½‘æ ¼ -->
    <div class="grid">
        <!-- ä»·æ ¼å¡ç‰‡ -->
        <div class="card">
            <div class="card-header"><i class="fas fa-chart-line"></i> Hä»·æ ¼</div>
            <div class="data-row">
                <span class="data-label">å½“å‰ä»·æ ¼</span>
                <span class="data-value" id="priceDisplay">0.00605</span>
            </div>
            <div class="data-detail">
                <span id="redlineDist">è·çº¢çº¿ +0.8%</span>
                <span class="chip" id="redlineStatus">å®‰å…¨</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="priceProgress" style="width: 80%;"></div></div>
        </div>

        <!-- äº¤æ˜“é‡å¡ç‰‡ -->
        <div class="card">
            <div class="card-header"><i class="fas fa-exchange-alt"></i> ä»Šæ—¥äº¤æ˜“é‡</div>
            <div class="data-row">
                <span class="data-label">ç´¯è®¡</span>
                <span class="data-value" id="dailyVolume">0 U</span>
            </div>
            <div class="data-detail">
                <span id="netVolume">å‡€æˆäº¤: 0 U</span>
                <span class="chip">ğŸ“ˆ ç´¯è®¡: <span id="totalVolume">0 U</span></span>
            </div>
        </div>

        <!-- è´¨æŠ¼æ€»é‡å¡ç‰‡ -->
        <div class="card">
            <div class="card-header"><i class="fas fa-lock"></i> è´¨æŠ¼æ€»é‡</div>
            <div class="data-row">
                <span class="data-label">H_staked</span>
                <span class="data-value" id="stakedDisplay">0 H</span>
            </div>
            <div class="data-detail">
                <span>ä»Šæ—¥ <span id="stakedDelta">0</span> H</span>
                <span>å¹³å‡å¤©æ•° <span id="avgDays">0</span></span>
                <span>åˆ©ç‡ <span id="rateDisplay">0%</span></span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="stakeRatioBar" style="width:0%"></div></div>
        </div>

        <!-- æµåŠ¨æ€§æ± å¡ç‰‡ -->
        <div class="card">
            <div class="card-header"><i class="fas fa-water"></i> æµåŠ¨æ€§æ± </div>
            <div class="data-row">
                <span class="data-label">H / U</span>
                <span class="data-value" id="lpHDisplay">18.18M</span>
            </div>
            <div class="data-detail">
                <span>U: <span id="lpUDisplay">110k</span></span>
                <span>Hå˜åŒ– <span id="lpHDelta">0</span></span>
                <span>Uå˜åŒ– <span id="lpUDelta">0</span></span>
            </div>
        </div>

        <!-- ç¤¾åŒºé’±åŒ…å¡ç‰‡ -->
        <div class="card">
            <div class="card-header"><i class="fas fa-wallet"></i> ç¤¾åŒºé’±åŒ…</div>
            <div class="data-row">
                <span class="data-label">U / H</span>
                <span class="data-value" id="communityUDisplay">20k</span>
            </div>
            <div class="data-detail">
                <span>H: <span id="communityHDisplay">681.82M</span></span>
                <span>Uå˜åŒ– <span id="communityUDelta">0</span></span>
                <span>Hå˜åŒ– <span id="communityHDelta">0</span></span>
            </div>
        </div>

        <!-- å›½åº“å¡ç‰‡ -->
        <div class="card">
            <div class="card-header"><i class="fas fa-landmark"></i> å›½åº“</div>
            <div class="data-row">
                <span class="data-label">USDT</span>
                <span class="data-value" id="treasuryDisplay">5,340</span>
            </div>
            <div class="data-detail">
                <span>ä»Šæ—¥å˜åŒ– <span id="treasuryDelta">0</span></span>
                <span class="chip" id="treasuryStatus">ä½™é‡å……è¶³</span>
            </div>
        </div>

        <!-- çŸ¿æ± å¡ç‰‡ -->
        <div class="card">
            <div class="card-header"><i class="fas fa-gem"></i> çŸ¿æ±  (æ”¶ç›Šå‚¨å¤‡)</div>
            <div class="data-row">
                <span class="data-label">H</span>
                <span class="data-value" id="rewardDisplay">300M</span>
            </div>
            <div class="data-detail">
                <span>ä»Šæ—¥å˜åŒ– <span id="rewardDelta">0</span></span>
                <span>å¯æ”¯ä»˜ <span id="rewardDays">âˆ</span>å¤©</span>
            </div>
        </div>

        <!-- çº¢çº¿çŠ¶æ€å¡ç‰‡ -->
        <div class="card">
            <div class="card-header"><i class="fas fa-shield-alt"></i> æŠ¤åŸæ²³</div>
            <div class="data-row">
                <span class="data-label">çº¢çº¿ä»·æ ¼</span>
                <span class="data-value" id="redlineValue">0.006</span>
            </div>
            <div class="data-detail">
                <span>å›è´­æ¬¡æ•° <span id="triggerCount">0</span></span>
                <span id="warningMsg" style="color:#8affb8;">â— å®‰å…¨</span>
            </div>
        </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="slider-panel">
        <div class="slider-group">
            <div class="slider-label">
                <span><i class="fas fa-arrow-down" style="color:#ff8a8a;"></i> <i class="fas fa-arrow-up" style="color:#8affb8;"></i> å¤–éƒ¨å‡€ä¹°å…¥ (USDT)</span>
                <span id="buyLabel" style="background:#1e2a3a; padding:2px 12px; border-radius:40px;">0</span>
            </div>
            <input type="range" id="buySlider" min="-50000" max="100000" value="0" step="1000">
            <div style="color:#7f92bb; font-size:12px;">è´Ÿå€¼ä»£è¡¨å‡€å–å‡º</div>
        </div>
        <div class="slider-group">
            <div class="slider-label">
                <span><i class="fas fa-unlock-alt"></i> ç”¨æˆ·è§£è´¨æŠ¼æ¯”ä¾‹ (%)</span>
                <span id="unstakeLabel" style="background:#1e2a3a; padding:2px 12px; border-radius:40px;">0%</span>
            </div>
            <input type="range" id="unstakeSlider" min="0" max="10" value="0" step="0.1">
        </div>
        <div class="button-group">
            <button class="btn btn-primary" id="stepBtn"><i class="fas fa-play"></i> æ¨¡æ‹Ÿä¸€å¤©</button>
            <button class="btn" id="resetBtn"><i class="fas fa-undo-alt"></i> é‡ç½®</button>
        </div>
    </div>

    <!-- äº‹ä»¶æ—¥å¿— -->
    <div class="flex" style="margin: 8px 4px;">
        <span style="color:#b0c6f0;"><i class="fas fa-history"></i> äº‹ä»¶æ—¥å¿—</span>
        <button id="clearLog" style="background:none; border:none; color:#7f92bb; font-size:12px; cursor:pointer;"><i class="fas fa-eraser"></i> æ¸…ç©º</button>
    </div>
    <div class="log-container" id="logContainer">
        <div class="log-entry">ğŸ”„ åˆå§‹çŠ¶æ€åŠ è½½å®Œæˆ</div>
    </div>
</div>

<script>
    (function() {
        // ---------- å›ºå®šå‚æ•° ----------
        const REDLINE = 0.006;                // ä»·æ ¼çº¢çº¿
        const TREASURY_TRIGGER = 1000;          // å›½åº“è§¦å‘é˜ˆå€¼
        const REPO_FROM_TREASURY = 300;         // å›½åº“æ¯æ¬¡å›è´­é‡‘é¢
        const TO_COMMUNITY = 700;                // å›½åº“æ¯æ¬¡è½¬å…¥ç¤¾åŒºé‡‘é¢
        const k = 200000000 * 10000;             // æ’å®šä¹˜ç§¯ 2e12

        // åˆ©ç‡é˜¶æ¢¯å‡½æ•°
        function getRateByAvgDays(avgDays) {
            if (avgDays <= 7) return 0.005;
            if (avgDays <= 15) return 0.006;
            if (avgDays <= 30) return 0.008;
            if (avgDays <= 60) return 0.01;
            return 0.012;
        }

        // ---------- åˆå§‹çŠ¶æ€ (ç¤¾åŒºç¬¬äºŒæ¬¡ä¹°å…¥10ä¸‡Uå) ----------
        let H_lp = k / 110000;                    // â‰ˆ 18,181,818.18
        let U_lp = 110000;
        let H_staked = 0;
        let totalStakedDays = 0;                   // ç´¯è®¡è´¨æŠ¼å¤©æ•°
        let H_reward = 300000000;                   // çŸ¿æ±  3äº¿H
        let communityH = 1000000000 - H_lp - H_reward; // â‰ˆ 681,818,182
        let treasury = 5340;                         // å›½åº“U
        let communityU = 20000;                       // ç¤¾åŒºé’±åŒ…U
        let totalVolume = 0;                           // ç´¯è®¡æ€»äº¤æ˜“é‡

        let day = 0;
        let triggerCount = 0;                          // çº¢çº¿å›è´­æ¬¡æ•°

        // å½“æ—¥å˜åŒ–é‡
        let dailyVolume = 0;
        let dailyNetBuy = 0;
        let deltaH_staked = 0;
        let deltaH_lp = 0;
        let deltaU_lp = 0;
        let deltaCommunityU = 0;
        let deltaCommunityH = 0;
        let deltaTreasury = 0;
        let deltaH_reward = 0;

        // ---------- DOM å…ƒç´  ----------
        const priceDisplay = document.getElementById('priceDisplay');
        const redlineDist = document.getElementById('redlineDist');
        const dailyVolumeEl = document.getElementById('dailyVolume');
        const netVolumeEl = document.getElementById('netVolume');
        const totalVolumeEl = document.getElementById('totalVolume');
        const stakedDisplay = document.getElementById('stakedDisplay');
        const stakedDelta = document.getElementById('stakedDelta');
        const avgDaysSpan = document.getElementById('avgDays');
        const rateDisplay = document.getElementById('rateDisplay');
        const lpHDisplay = document.getElementById('lpHDisplay');
        const lpUDisplay = document.getElementById('lpUDisplay');
        const lpHDelta = document.getElementById('lpHDelta');
        const lpUDelta = document.getElementById('lpUDelta');
        const communityUDisplay = document.getElementById('communityUDisplay');
        const communityHDisplay = document.getElementById('communityHDisplay');
        const communityUDelta = document.getElementById('communityUDelta');
        const communityHDelta = document.getElementById('communityHDelta');
        const treasuryDisplay = document.getElementById('treasuryDisplay');
        const treasuryDelta = document.getElementById('treasuryDelta');
        const rewardDisplay = document.getElementById('rewardDisplay');
        const rewardDelta = document.getElementById('rewardDelta');
        const rewardDays = document.getElementById('rewardDays');
        const triggerCountSpan = document.getElementById('triggerCount');
        const warningMsg = document.getElementById('warningMsg');
        const redlineStatus = document.getElementById('redlineStatus');
        const treasuryStatus = document.getElementById('treasuryStatus');
        const priceProgress = document.getElementById('priceProgress');
        const stakeRatioBar = document.getElementById('stakeRatioBar');

        const buyLabel = document.getElementById('buyLabel');
        const unstakeLabel = document.getElementById('unstakeLabel');
        const buySlider = document.getElementById('buySlider');
        const unstakeSlider = document.getElementById('unstakeSlider');
        const stepBtn = document.getElementById('stepBtn');
        const resetBtn = document.getElementById('resetBtn');
        const logContainer = document.getElementById('logContainer');
        const clearLog = document.getElementById('clearLog');

        // æ—¥å¿—å‡½æ•°
        function addLog(message) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `â±ï¸ ${new Date().toLocaleTimeString()} ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        clearLog.addEventListener('click', () => {
            logContainer.innerHTML = '<div class="log-entry">ğŸ“‹ æ—¥å¿—å·²æ¸…ç©º</div>';
        });

        // é«˜äº®æ›´æ–°å‡½æ•°
        function updateHighlights() {
            const price = U_lp / H_lp;
            const ratio = H_staked / H_lp;
            const priceEl = priceDisplay;
            const stakedEl = stakedDisplay;
            const treasuryEl = treasuryDisplay;
            const communityUEl = communityUDisplay;

            // ä»·æ ¼é«˜äº®
            if (price <= REDLINE) {
                priceEl.classList.add('value-danger');
                priceEl.classList.remove('value-warning', 'value-neutral');
                redlineStatus.innerText = 'â— å·²è·Œç ´çº¢çº¿';
                redlineStatus.style.color = '#ff6b6b';
            } else if (price < REDLINE * 1.05) {
                priceEl.classList.add('value-warning');
                priceEl.classList.remove('value-danger', 'value-neutral');
                redlineStatus.innerText = 'âš ï¸ æ¥è¿‘çº¢çº¿';
                redlineStatus.style.color = '#ffb347';
            } else {
                priceEl.classList.add('value-neutral');
                priceEl.classList.remove('value-danger', 'value-warning');
                redlineStatus.innerText = 'â— å®‰å…¨';
                redlineStatus.style.color = '#8affb8';
            }

            // è´¨æŠ¼æ¯”ç‡é«˜äº®
            if (ratio > 0.8) {
                stakedEl.classList.add('value-danger');
                stakedEl.classList.remove('value-warning', 'value-neutral');
            } else if (ratio > 0.6) {
                stakedEl.classList.add('value-warning');
                stakedEl.classList.remove('value-danger', 'value-neutral');
            } else {
                stakedEl.classList.add('value-neutral');
                stakedEl.classList.remove('value-danger', 'value-warning');
            }

            // å›½åº“é«˜äº®
            if (treasury >= 900) {
                treasuryEl.classList.add('value-warning');
                treasuryEl.classList.remove('value-danger', 'value-neutral');
                treasuryStatus.innerText = 'å³å°†è§¦å‘';
                treasuryStatus.style.color = '#ffb347';
            } else if (treasury >= 1000) {
                // å®é™…ä¸ä¼šåœç•™ï¼Œå› ä¸ºè§¦å‘ä¼šç«‹å³æ‰£é™¤ï¼Œä½†ä¿ç•™é€»è¾‘
                treasuryEl.classList.add('value-danger');
                treasuryStatus.innerText = 'è§¦å‘ä¸­';
                treasuryStatus.style.color = '#ff6b6b';
            } else {
                treasuryEl.classList.add('value-neutral');
                treasuryEl.classList.remove('value-danger', 'value-warning');
                treasuryStatus.innerText = 'ä½™é‡å……è¶³';
                treasuryStatus.style.color = '#8affb8';
            }

            // ç¤¾åŒºUé«˜äº® (æŠ¤åŸæ²³)
            if (communityU < 5000) {
                communityUEl.classList.add('value-danger');
                communityUEl.classList.remove('value-warning', 'value-neutral');
            } else if (communityU < 10000) {
                communityUEl.classList.add('value-warning');
                communityUEl.classList.remove('value-danger', 'value-neutral');
            } else {
                communityUEl.classList.add('value-neutral');
                communityUEl.classList.remove('value-danger', 'value-warning');
            }

            // å¯æ”¯ä»˜å¤©æ•°é«˜äº® (åœ¨ rewardDays çˆ¶çº§ä¸å¥½ç›´æ¥æ”¹ï¼Œæˆ‘ä»¬å•ç‹¬å¤„ç†)
            const daysElem = rewardDays;
            const daysText = daysElem.innerText;
            if (daysText !== 'âˆ') {
                const days = parseInt(daysText);
                if (days < 30) {
                    daysElem.style.color = '#ff6b6b';
                } else if (days < 100) {
                    daysElem.style.color = '#ffb347';
                } else {
                    daysElem.style.color = '#a0b5d8';
                }
            } else {
                daysElem.style.color = '#a0b5d8';
            }

            // è¿›åº¦æ¡ï¼šä»·æ ¼çº¢çº¿è¿›åº¦ (ä»·æ ¼ / (çº¢çº¿*2) é€‚å½“ç¼©æ”¾)
            let pricePercent = Math.min(100, (price / (REDLINE * 2)) * 100);
            priceProgress.style.width = pricePercent + '%';
            if (price <= REDLINE) priceProgress.style.background = '#ff6b6b';
            else if (price < REDLINE*1.2) priceProgress.style.background = '#ffb347';
            else priceProgress.style.background = 'linear-gradient(90deg, #4c9aff, #6fafff)';

            // è´¨æŠ¼æ¯”ä¾‹è¿›åº¦æ¡
            let ratioPercent = Math.min(100, ratio * 100);
            stakeRatioBar.style.width = ratioPercent + '%';
            if (ratio > 0.8) stakeRatioBar.style.background = '#ff6b6b';
            else if (ratio > 0.6) stakeRatioBar.style.background = '#ffb347';
            else stakeRatioBar.style.background = 'linear-gradient(90deg, #4c9aff, #6fafff)';
        }

        // æ›´æ–°UI
        function updateUI() {
            const price = U_lp / H_lp;
            priceDisplay.textContent = price.toFixed(6);
            const dist = ((price - REDLINE) / REDLINE * 100).toFixed(1);
            redlineDist.textContent = `è·çº¢çº¿ ${price > REDLINE ? '+' : ''}${dist}%`;

            dailyVolumeEl.textContent = Math.round(dailyVolume).toLocaleString() + ' U';
            netVolumeEl.textContent = `å‡€æˆäº¤: ${dailyNetBuy > 0 ? '+' : ''}${Math.round(dailyNetBuy).toLocaleString()} U`;
            if (dailyNetBuy > 0) netVolumeEl.style.color = '#6bcf7f';
            else if (dailyNetBuy < 0) netVolumeEl.style.color = '#ff8a8a';
            else netVolumeEl.style.color = '#a0b5d8';
            totalVolumeEl.textContent = Math.round(totalVolume).toLocaleString() + ' U';

            stakedDisplay.textContent = (H_staked / 1e6).toFixed(2) + 'M H';
            stakedDelta.textContent = (deltaH_staked > 0 ? '+' : '') + Math.round(deltaH_staked).toLocaleString();

            const avgDays = H_staked > 0 ? (totalStakedDays / H_staked).toFixed(1) : 0;
            avgDaysSpan.textContent = avgDays;
            const rate = H_staked > 0 ? (getRateByAvgDays(totalStakedDays / H_staked) * 100).toFixed(2) : 0;
            rateDisplay.textContent = rate + '%';

            lpHDisplay.textContent = (H_lp / 1e6).toFixed(2) + 'M H';
            lpUDisplay.textContent = Math.round(U_lp / 1000) + 'k U';
            lpHDelta.textContent = (deltaH_lp > 0 ? '+' : '') + Math.round(deltaH_lp).toLocaleString();
            lpUDelta.textContent = (deltaU_lp > 0 ? '+' : '') + Math.round(deltaU_lp).toLocaleString();

            communityUDisplay.textContent = Math.round(communityU / 1000) + 'k U';
            communityHDisplay.textContent = (communityH / 1e6).toFixed(2) + 'M H';
            communityUDelta.textContent = (deltaCommunityU > 0 ? '+' : '') + Math.round(deltaCommunityU).toLocaleString();
            communityHDelta.textContent = (deltaCommunityH > 0 ? '+' : '') + Math.round(deltaCommunityH).toLocaleString();

            treasuryDisplay.textContent = Math.round(treasury).toLocaleString() + ' U';
            treasuryDelta.textContent = (deltaTreasury > 0 ? '+' : '') + Math.round(deltaTreasury).toLocaleString();

            rewardDisplay.textContent = (H_reward / 1e6).toFixed(1) + 'M H';
            rewardDelta.textContent = (deltaH_reward > 0 ? '+' : '') + Math.round(deltaH_reward).toLocaleString();

            // å¯æ”¯ä»˜å¤©æ•°
            if (H_staked > 0) {
                const avg = totalStakedDays / H_staked;
                const r = getRateByAvgDays(avg);
                const dailyPayoutH = H_staked * r;
                const days = Math.floor(H_reward / dailyPayoutH);
                rewardDays.textContent = days.toLocaleString();
            } else {
                rewardDays.textContent = 'âˆ';
            }

            triggerCountSpan.textContent = triggerCount;

            // çº¢çº¿é¢„è­¦
            if (price <= REDLINE) {
                warningMsg.innerHTML = 'â— å·²è·Œç ´çº¢çº¿';
                warningMsg.style.color = '#ff6b6b';
            } else {
                warningMsg.innerHTML = 'â— å®‰å…¨';
                warningMsg.style.color = '#8affb8';
            }

            // è°ƒç”¨é«˜äº®å‡½æ•°
            updateHighlights();
        }

        function resetDailyChanges() {
            dailyVolume = 0;
            dailyNetBuy = 0;
            deltaH_staked = 0;
            deltaH_lp = 0;
            deltaU_lp = 0;
            deltaCommunityU = 0;
            deltaCommunityH = 0;
            deltaTreasury = 0;
            deltaH_reward = 0;
        }

        // æ¨¡æ‹Ÿä¸€å¤©
        function simulateDay(externalBuy, unstakePct) {
            let log = [];
            log.push(`========== ç¬¬ ${day + 1} å¤©å¼€å§‹ ==========`);
            resetDailyChanges();

            if (H_staked > 0) totalStakedDays += H_staked;

            // 1. å¤–éƒ¨ä¹°å–
            if (Math.abs(externalBuy) > 0.01) {
                if (externalBuy > 0) {
                    let buyU = Math.min(externalBuy, U_lp * 0.9);
                    let newU = U_lp + buyU;
                    let newH = k / newU;
                    let hOut = H_lp - newH;
                    let oldH_lp = H_lp, oldU_lp = U_lp, oldH_staked = H_staked;
                    H_lp = newH; U_lp = newU;
                    H_staked += hOut;
                    deltaH_lp += H_lp - oldH_lp;
                    deltaU_lp += U_lp - oldU_lp;
                    deltaH_staked += H_staked - oldH_staked;

                    let tax = buyU * 0.05;
                    let rebate = buyU * 0.0034;
                    treasury += tax + rebate;
                    deltaTreasury += tax + rebate;

                    dailyVolume += buyU;
                    dailyNetBuy += buyU;
                    totalVolume += buyU;
                    log.push(`ğŸ’° å¤–éƒ¨ä¹°å…¥ ${Math.round(buyU)} Uï¼Œæ¶ˆè€— H ${Math.round(hOut)}ï¼Œå…¨éƒ¨è´¨æŠ¼ã€‚ç¨è´¹ ${Math.round(tax)} Uï¼Œè¿”ä½£ ${Math.round(rebate)} U`);
                } else {
                    let sellU = Math.min(-externalBuy, U_lp * 0.9);
                    let newU = U_lp - sellU;
                    if (newU <= 0) newU = 1;
                    let newH = k / newU;
                    let deltaH = newH - H_lp;
                    let oldH_lp = H_lp, oldU_lp = U_lp, oldH_staked = H_staked;
                    H_lp = newH; U_lp = newU;
                    let actualSellH = Math.min(deltaH, H_staked);
                    H_staked -= actualSellH;
                    if (oldH_staked > 0) {
                        totalStakedDays = totalStakedDays * (1 - actualSellH / oldH_staked);
                    }
                    deltaH_lp += H_lp - oldH_lp;
                    deltaU_lp += U_lp - oldU_lp;
                    deltaH_staked += H_staked - oldH_staked;

                    let tax = sellU * 0.05;
                    let rebate = sellU * 0.0034;
                    treasury += tax + rebate;
                    deltaTreasury += tax + rebate;

                    dailyVolume += sellU;
                    dailyNetBuy -= sellU;
                    totalVolume += sellU;
                    log.push(`ğŸ“‰ å¤–éƒ¨å–å‡º ${Math.round(sellU)} Uï¼Œå–å‡º H ${Math.round(actualSellH)}ï¼Œç¨è´¹ ${Math.round(tax)} Uï¼Œè¿”ä½£ ${Math.round(rebate)} U`);
                }
            }

            // 2. ç”¨æˆ·è§£è´¨æŠ¼
            if (unstakePct > 0.001 && H_staked > 0) {
                let sellH = H_staked * (unstakePct / 100);
                let oldH_lp = H_lp, oldU_lp = U_lp, oldH_staked = H_staked;
                let newH = H_lp + sellH;
                let newU = k / newH;
                let receivedU = U_lp - newU;
                H_lp = newH; U_lp = newU;
                H_staked -= sellH;
                if (oldH_staked > 0) {
                    totalStakedDays = totalStakedDays * (1 - sellH / oldH_staked);
                }
                deltaH_lp += H_lp - oldH_lp;
                deltaU_lp += U_lp - oldU_lp;
                deltaH_staked += H_staked - oldH_staked;

                let tax = receivedU * 0.05;
                let rebate = receivedU * 0.0034;
                treasury += tax + rebate;
                deltaTreasury += tax + rebate;

                dailyVolume += receivedU;
                dailyNetBuy -= receivedU;
                totalVolume += receivedU;
                log.push(`ğŸ”“ è§£è´¨æŠ¼ ${(unstakePct * 100).toFixed(1)}% å–å‡º H ${Math.round(sellH)}ï¼Œè·å¾— ${Math.round(receivedU)} Uï¼Œç¨è´¹ ${Math.round(tax)} U`);
            }

            // 3. 20ç‚¹æ”¶ç›Šå‘æ”¾
            if (H_staked > 0) {
                const price = U_lp / H_lp;
                const avg = totalStakedDays / H_staked;
                const rate = getRateByAvgDays(avg);
                let payoutH = H_staked * rate;
                if (payoutH > H_reward) payoutH = H_reward;
                let oldH_staked = H_staked;
                let oldH_reward = H_reward;
                H_reward -= payoutH;
                H_staked += payoutH;
                deltaH_staked += H_staked - oldH_staked;
                deltaH_reward += H_reward - oldH_reward;
                log.push(`ğŸ•’ 20ç‚¹æ”¶ç›Šï¼šå¹³å‡å¤©æ•° ${avg.toFixed(1)}ï¼Œåˆ©ç‡ ${(rate * 100).toFixed(2)}%ï¼Œå‘æ”¾ ${Math.round(payoutH)} H (å¤æŠ•)`);
            } else {
                log.push(`â¸ï¸ 20ç‚¹æ— æ”¶ç›Š (è´¨æŠ¼0)`);
            }

            // 4. å›½åº“å›è´­
            while (treasury >= TREASURY_TRIGGER) {
                let buyU = Math.min(REPO_FROM_TREASURY, U_lp * 0.9);
                let oldH_lp = H_lp, oldU_lp = U_lp, oldCommunityH = communityH, oldTreasury = treasury, oldCommunityU = communityU;
                let newU = U_lp + buyU;
                let newH = k / newU;
                let hBought = H_lp - newH;
                H_lp = newH; U_lp = newU;
                communityH += hBought;
                deltaCommunityH += hBought;
                treasury -= buyU;
                communityU += TO_COMMUNITY;
                treasury -= TO_COMMUNITY;
                deltaH_lp += H_lp - oldH_lp;
                deltaU_lp += U_lp - oldU_lp;
                deltaCommunityU += communityU - oldCommunityU;
                deltaTreasury += treasury - oldTreasury;
                log.push(`ğŸ¦ å›½åº“è§¦å‘ï¼š300Uå›è´­ H ${Math.round(hBought)} (ç¤¾åŒºH: ${(oldCommunityH/1e6).toFixed(2)}M â†’ ${(communityH/1e6).toFixed(2)}M)ï¼Œ700Uè½¬ç¤¾åŒºï¼Œå›½åº“å‰©ä½™ ${Math.round(treasury)} U`);
            }

            // 5. çº¢çº¿å›è´­
            let price = U_lp / H_lp;
            let repoCount = 0;
            while (price <= REDLINE && communityU > 1 && repoCount < 10) {
                let targetPrice = REDLINE * 1.02;
                let neededU = Math.sqrt(targetPrice * k) - U_lp;
                if (neededU <= 0) break;
                let buyU = Math.min(neededU, communityU);
                if (buyU < 0.01) break;
                let oldH_lp = H_lp, oldU_lp = U_lp, oldCommunityU = communityU, oldCommunityH = communityH;
                let newU = U_lp + buyU;
                let newH = k / newU;
                let hBought = H_lp - newH;
                H_lp = newH; U_lp = newU;
                communityU -= buyU;
                communityH += hBought;
                deltaCommunityH += hBought;
                deltaH_lp += H_lp - oldH_lp;
                deltaU_lp += U_lp - oldU_lp;
                deltaCommunityU += communityU - oldCommunityU;
                triggerCount++;
                repoCount++;
                log.push(`ğŸš¨ çº¢çº¿å›è´­ #${repoCount}ï¼šèŠ±è´¹ ${Math.round(buyU)} U ä¹°å…¥ ${Math.round(hBought)} H (ç¤¾åŒºH: ${(oldCommunityH/1e6).toFixed(2)}M â†’ ${(communityH/1e6).toFixed(2)}M)`);
                price = U_lp / H_lp;
                if (price > REDLINE) break;
            }
            if (repoCount > 0) {
                log.push(`âœ… çº¢çº¿å›è´­ç»“æŸï¼Œä»·æ ¼ $${price.toFixed(6)}`);
            }

            day++;
            log.forEach(msg => addLog(msg));
            updateUI();
        }

        function reset() {
            H_lp = k / 110000;
            U_lp = 110000;
            H_staked = 0;
            totalStakedDays = 0;
            H_reward = 300000000;
            communityH = 1000000000 - H_lp - H_reward;
            treasury = 5340;
            communityU = 20000;
            totalVolume = 0;
            day = 0;
            triggerCount = 0;
            resetDailyChanges();
            addLog('ğŸ” é‡ç½®è‡³åˆå§‹çŠ¶æ€ (ç¤¾åŒºä¹°å…¥10ä¸‡Uåï¼Œä»·æ ¼â‰ˆ0.00605ï¼Œè´¨æŠ¼0)');
            updateUI();
        }

        stepBtn.addEventListener('click', () => {
            let buy = parseFloat(buySlider.value);
            let unstake = parseFloat(unstakeSlider.value);
            buyLabel.textContent = buy;
            unstakeLabel.textContent = unstake + '%';
            simulateDay(buy, unstake);
        });

        resetBtn.addEventListener('click', reset);

        buySlider.addEventListener('input', () => {
            buyLabel.textContent = buySlider.value;
        });
        unstakeSlider.addEventListener('input', () => {
            unstakeLabel.textContent = unstakeSlider.value + '%';
        });

        reset();
    })();
</script>
</body>
</html>
