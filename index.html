<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>æµ·è±šæ¨¡å¼ Â· ç»æµæ¨¡å‹æ¨¡æ‹Ÿå™¨ï¼ˆçº¢çº¿0.006ï¼‰</title>
    <!-- Chart.js è½»é‡å›¾è¡¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- å­—ä½“ä¸åŸºç¡€æ ·å¼ -->
    <style>
        * { box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 0; }
        body { background: #0a0c10; display: flex; justify-content: center; padding: 16px; }
        .container { max-width: 420px; width: 100%; background: #11161e; border-radius: 48px; padding: 20px 16px; box-shadow: 0 20px 40px #00000080; border: 0.5px solid #2a3240; }
        h2 { color: #d0e0ff; font-weight: 600; font-size: 24px; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .sub { color: #8892b0; font-size: 14px; margin-bottom: 24px; border-left: 3px solid #4c9aff; padding-left: 12px; }
        .card { background: #1b212b; border-radius: 28px; padding: 18px 16px; margin-bottom: 20px; border: 0.5px solid #2f3a4b; }
        .card-title { color: #b0c8ff; font-weight: 500; margin-bottom: 14px; display: flex; align-items: center; gap: 6px; }
        .metric-row { display: flex; flex-wrap: wrap; gap: 16px; justify-content: space-between; }
        .metric-item { background: #10141c; border-radius: 20px; padding: 12px; flex: 1 0 40%; }
        .metric-label { color: #8592b5; font-size: 13px; }
        .metric-value { color: white; font-size: 22px; font-weight: 600; }
        .metric-detail { color: #a0b0d0; font-size: 13px; }
        .danger { color: #ff7575; }
        .safe { color: #75d787; }
        hr { border: none; border-top: 1px solid #29313e; margin: 16px 0; }
        .slider-group { margin: 18px 0; }
        .slider-label { display: flex; justify-content: space-between; color: #b4c2e0; }
        input[type=range] { width: 100%; margin: 8px 0; background: #2a3440; height: 6px; border-radius: 20px; -webkit-appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 22px; height: 22px; background: #fff; border-radius: 50%; border: 2px solid #4c9aff; cursor: pointer; }
        .btn-group { display: flex; gap: 12px; margin: 24px 0 12px; }
        .btn { background: #2c3b51; border: none; color: white; padding: 14px 0; border-radius: 60px; font-weight: 600; flex: 1; font-size: 16px; transition: 0.2s; border: 0.5px solid #4b5e7c; }
        .btn.primary { background: #4c9aff; color: black; border: none; }
        .btn:active { opacity: 0.8; }
        .warning-tag { background: #4a2f2f; color: #ffa5a5; border-radius: 40px; padding: 8px 16px; font-size: 14px; text-align: center; }
        .chart-container { height: 160px; margin: 16px 0; }
        .footnote { color: #5f6e8c; font-size: 12px; text-align: center; margin-top: 20px; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .badge { background: #2f3d57; border-radius: 30px; padding: 4px 12px; font-size: 13px; }
    </style>
</head>
<body>
<div class="container">
    <h2>ğŸ¬ æµ·è±šç»æµæ¨¡å‹ Â· çº¢çº¿0.006</h2>
    <div class="sub">ç¤¾åŒºå¤šç­¾è‡ªåŠ¨å›è´­ Â· é£è½®æ¨æ¼”</div>

    <!-- æ ¸å¿ƒçŠ¶æ€å¡ç‰‡ (åŠ¨æ€æ›´æ–°) -->
    <div class="card">
        <div class="card-title"><span>ğŸ“Š å½“å‰çŠ¶æ€</span> <span class="badge" id="dayDisplay">ç¬¬ 0 å¤©</span></div>
        <div class="metric-row">
            <div class="metric-item">
                <div class="metric-label">H ä»·æ ¼</div>
                <div class="metric-value" id="priceDisplay">$0.02205</div>
                <div class="metric-detail" id="priceDistance">è·çº¢çº¿ +267%</div>
            </div>
            <div class="metric-item">
                <div class="metric-label">æµåŠ¨æ€§æ±  H</div>
                <div class="metric-value" id="lpHDisplay">9.52M</div>
                <div class="metric-detail">USDT: <span id="lpUDisplay">210k</span></div>
            </div>
        </div>
        <div class="metric-row">
            <div class="metric-item">
                <div class="metric-label">è´¨æŠ¼é‡ (H_staked)</div>
                <div class="metric-value" id="stakedDisplay">8.66M</div>
                <div class="metric-detail">å æ¯”æ± å­ <span id="stakeRatio">91%</span></div>
            </div>
            <div class="metric-item">
                <div class="metric-label">æ”¶ç›Šå‚¨å¤‡</div>
                <div class="metric-value" id="rewardDisplay">300.0M</div>
                <div class="metric-detail">å¯æ”¯ä»˜ <span id="rewardDays">6615</span> å¤©</div>
            </div>
        </div>
        <div class="metric-row">
            <div class="metric-item">
                <div class="metric-label">å›½åº“ USDT</div>
                <div class="metric-value" id="treasuryDisplay">5,340</div>
                <div class="metric-detail">å¾…è½¬</div>
            </div>
            <div class="metric-item">
                <div class="metric-label">ç¤¾åŒºé’±åŒ… USDT</div>
                <div class="metric-value" id="communityUDisplay">20,000</div>
                <div class="metric-detail">H: <span id="communityHDisplay">500.0M</span></div>
            </div>
        </div>
    </div>

    <!-- å‚æ•°è°ƒèŠ‚é¢æ¿ -->
    <div class="card">
        <div class="card-title">âš™ï¸ æ¯æ—¥å¸‚åœºå‚æ•°</div>
        <div class="slider-group">
            <div class="slider-label"><span>å¤–éƒ¨å‡€ä¹°å…¥ (USDT/å¤©)</span> <span id="buyInLabel">0</span></div>
            <input type="range" id="buyInput" min="-50000" max="100000" value="0" step="1000">
            <div style="color:#a0b0d0; font-size:13px;">è´Ÿå€¼ä¸ºå‡€å–å‡º</div>
        </div>
        <div class="slider-group">
            <div class="slider-label"><span>ç”¨æˆ·è§£è´¨æŠ¼æ¯”ä¾‹ (%)</span> <span id="unstakeLabel">0%</span></div>
            <input type="range" id="unstakeInput" min="0" max="10" value="0" step="0.1">
            <div style="color:#a0b0d0; font-size:13px;">æ¯æ—¥è§£è´¨æŠ¼å¹¶å–å‡ºçš„æ¯”ä¾‹ (å  H_staked)</div>
        </div>
        <div class="btn-group">
            <button class="btn" id="stepBtn">â© æ¨¡æ‹Ÿä¸€å¤©</button>
            <button class="btn primary" id="resetBtn">âŸ² é‡ç½®åˆå§‹</button>
        </div>
        <!-- çº¢çº¿é¢„è­¦ & å›è´­ä¿¡æ¯ -->
        <div id="warningMessage" class="warning-tag" style="margin-top:12px;">ğŸŸ¢ ä»·æ ¼å®‰å…¨ï¼Œå›è´­æœªè§¦å‘</div>
    </div>

    <!-- ä»·æ ¼è¶‹åŠ¿å›¾ (æœ€è¿‘30å¤©) -->
    <div class="card">
        <div class="card-title">ğŸ“ˆ ä»·æ ¼å†å² (æœ€è¿‘30æ­¥)</div>
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>
        <div class="flex-between" style="margin-top:8px;">
            <span style="color:#b0c0e0;">çº¢çº¿ 0.006</span>
            <span style="color:#b0c0e0;" id="triggerCount">å›è´­è§¦å‘: 0 æ¬¡</span>
        </div>
    </div>

    <!-- æ¨¡å‹è§£æ -->
    <div class="card" style="background: #1a212c;">
        <div class="card-title">ğŸ§  æ¨¡å‹é€»è¾‘ä¸çº¢çº¿æœºåˆ¶</div>
        <ul style="color:#b0c4de; font-size:14px; line-height:1.6; padding-left:20px;">
            <li>åˆå§‹çŠ¶æ€ï¼šåŸºäºç¬¬äºŒé˜¶æ®µå (H_lp=9.52M, U_lp=210k, ä»·æ ¼â‰ˆ0.02205)ï¼›è´¨æŠ¼æ±  8.66M Hï¼Œæ”¶ç›Šå‚¨å¤‡ 300M Hã€‚</li>
            <li>æ¯æ—¥æ”¶ç›Šï¼šå›ºå®šæ”¯ä»˜ 1000 USDTç­‰å€¼ H (ä»æ”¶ç›Šå‚¨å¤‡æ”¯å‡ºï¼Œè‡ªåŠ¨å¤æŠ• â†’ H_staked å¢åŠ )ã€‚</li>
            <li>å›½åº“æ”¶å…¥ï¼šäº¤æ˜“é‡(å¤–éƒ¨ä¹°å–+å›è´­)çš„ 5% ç¨è´¹ + 0.34% OKXè¿”ä½£ï¼›æ¯ç´¯ç§¯ 1000 USDT è§¦å‘ï¼š300U å¸‚ä»·å›è´­ï¼Œ700U è½¬å…¥ç¤¾åŒºå¤šç­¾é’±åŒ…ã€‚</li>
            <li><span style="color:#ffaa66;">çº¢çº¿ 0.006</span>ï¼šè‹¥ä»·æ ¼ â‰¤ 0.006ï¼Œç¤¾åŒºå¤šç­¾é’±åŒ…è‡ªåŠ¨ä½¿ç”¨å…¶ USDT ä½™é¢ä¹°å…¥ Hï¼Œç›´è‡³ä»·æ ¼ > 0.006 æˆ– USDT è€—å°½ã€‚</li>
            <li>å±é™©æŒ‡æ ‡ï¼šè´¨æŠ¼é‡/æ± å­Hæ¯”ç‡ > 1 æ—¶æŠ›å‹æå¤§ï¼›å›½åº“+ç¤¾åŒºUå¯æ”¯æ’‘çš„ä¹°ç›˜å¤§å°å†³å®šæŠ—è·Œèƒ½åŠ›ã€‚</li>
        </ul>
    </div>
    <div class="footnote">æ‹–åŠ¨å‚æ•°ï¼ŒæŒ‰â€œæ¨¡æ‹Ÿä¸€å¤©â€è§‚å¯ŸåŠ¨æ€ã€‚å›è´­æ¬¡æ•°åŠä»·æ ¼å˜åŒ–å®æ—¶æ›´æ–°ã€‚</div>
</div>

<script>
    (function() {
        // ---------- åˆå§‹å‚æ•° (åŸºäºè®¨è®º) ----------
        // æµåŠ¨æ€§æ± 
        let H_lp = 18181818.18 * 0.5238; // å®é™…ä¸Šç¬¬äºŒé˜¶æ®µå H_lp â‰ˆ 9.5238M  (ä¹‹å‰è®¡ç®—ç²¾ç¡®å€¼)
        // æ›´ç²¾ç¡®ï¼šk = 2e12, åˆå§‹U_lp=110k, ä¹°å…¥100k Uå U_lp=210k, H_lp = k/210k = 2e12/210000 = 9523809.52
        H_lp = 9523809.52;               // 9.5238 M
        let U_lp = 210000;                // 210,000 USDT
        const k = H_lp * U_lp;             // æ’å®šä¹˜ç§¯ 2e12

        // è´¨æŠ¼æ± 
        let H_staked = 8660000;            // çº¦8.66M (ç”¨æˆ·å…¨éƒ¨è´¨æŠ¼)
        let H_reward = 300000000;           // 3äº¿æ”¶ç›Šå‚¨å¤‡

        // å›½åº“ & ç¤¾åŒºé’±åŒ…
        let treasury = 5340;                 // åˆå§‹äº¤æ˜“ç¨è´¹+è¿”ä½£ (ä»10ä¸‡Uä¹°å…¥äº§ç”Ÿ)
        let communityU = 20000;               // å‡è®¾ç¤¾åŒºå¤šç­¾é’±åŒ…å·²æœ‰ 2ä¸‡ USDT ç”¨äºçº¢çº¿å›è´­
        let communityH = 500000000;            // 5äº¿ H (æˆ˜ç•¥å‚¨å¤‡)

        // è¾…åŠ©å˜é‡
        let day = 0;
        let triggerCount = 0;                  // å›è´­è§¦å‘æ¬¡æ•°
        let priceHistory = [];                  // å­˜å‚¨æœ€è¿‘ä»·æ ¼ç”¨äºå›¾è¡¨

        // å¸¸é‡
        const PRICE_REDLINE = 0.006;
        const DAILY_PAYOUT_USD = 1000;           // æ¯æ—¥æ”¯ä»˜1000Uç­‰å€¼H

        // è·å–DOMå…ƒç´ 
        const priceDisplay = document.getElementById('priceDisplay');
        const priceDistance = document.getElementById('priceDistance');
        const lpHDisplay = document.getElementById('lpHDisplay');
        const lpUDisplay = document.getElementById('lpUDisplay');
        const stakedDisplay = document.getElementById('stakedDisplay');
        const stakeRatio = document.getElementById('stakeRatio');
        const rewardDisplay = document.getElementById('rewardDisplay');
        const rewardDays = document.getElementById('rewardDays');
        const treasuryDisplay = document.getElementById('treasuryDisplay');
        const communityUDisplay = document.getElementById('communityUDisplay');
        const communityHDisplay = document.getElementById('communityHDisplay');
        const dayDisplay = document.getElementById('dayDisplay');
        const warningMessage = document.getElementById('warningMessage');
        const triggerCountSpan = document.getElementById('triggerCount');
        const buyInLabel = document.getElementById('buyInLabel');
        const unstakeLabel = document.getElementById('unstakeLabel');
        const buyInput = document.getElementById('buyInput');
        const unstakeInput = document.getElementById('unstakeInput');
        const stepBtn = document.getElementById('stepBtn');
        const resetBtn = document.getElementById('resetBtn');

        // å›¾è¡¨åˆå§‹åŒ–
        const ctx = document.getElementById('priceChart').getContext('2d');
        let priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array(30).fill(''),
                datasets: [{
                    label: 'H ä»·æ ¼',
                    data: Array(30).fill(null),
                    borderColor: '#4c9aff',
                    backgroundColor: 'rgba(76,154,255,0.1)',
                    tension: 0.2,
                    pointRadius: 2,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { min: 0, grid: { color: '#2a3340' }, ticks: { color: '#aaa' } }, x: { display: false } },
                plugins: { legend: { display: false } }
            }
        });

        // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
        function updateDisplay() {
            const price = U_lp / H_lp;
            // ä»·æ ¼
            priceDisplay.innerText = '$' + price.toFixed(6);
            const dist = ((price - PRICE_REDLINE) / PRICE_REDLINE * 100).toFixed(1);
            priceDistance.innerText = `è·çº¢çº¿ ${price>PRICE_REDLINE?'+':''}${dist}%`;
            // æµåŠ¨æ€§
            lpHDisplay.innerText = (H_lp/1e6).toFixed(2) + 'M';
            lpUDisplay.innerText = Math.round(U_lp).toLocaleString();
            // è´¨æŠ¼
            stakedDisplay.innerText = (H_staked/1e6).toFixed(2) + 'M';
            const ratio = (H_staked / H_lp * 100).toFixed(1);
            stakeRatio.innerText = ratio + '%';
            if (H_staked > H_lp) stakeRatio.style.color = '#ff7575';
            else stakeRatio.style.color = '#a0b0d0';
            // æ”¶ç›Šå‚¨å¤‡
            rewardDisplay.innerText = (H_reward/1e6).toFixed(1) + 'M';
            const payoutH = DAILY_PAYOUT_USD / price;
            const days = Math.floor(H_reward / payoutH);
            rewardDays.innerText = days.toLocaleString();
            // å›½åº“ & ç¤¾åŒº
            treasuryDisplay.innerText = Math.round(treasury).toLocaleString();
            communityUDisplay.innerText = Math.round(communityU).toLocaleString();
            communityHDisplay.innerText = (communityH/1e6).toFixed(1) + 'M';

            dayDisplay.innerText = `ç¬¬ ${day} å¤©`;
            triggerCountSpan.innerText = `å›è´­è§¦å‘: ${triggerCount} æ¬¡`;

            // çº¢çº¿é¢„è­¦
            if (price <= PRICE_REDLINE) {
                warningMessage.innerHTML = 'ğŸ”´ ä»·æ ¼è§¦åŠçº¢çº¿ï¼ç¤¾åŒºå›è´­å·²æ¿€æ´»';
                warningMessage.style.background = '#4f2b2b';
            } else {
                warningMessage.innerHTML = 'ğŸŸ¢ ä»·æ ¼å®‰å…¨ï¼Œå›è´­æœªè§¦å‘';
                warningMessage.style.background = '#2a4030';
            }

            // æ›´æ–°å›¾è¡¨ (è¿½åŠ å½“å‰ä»·æ ¼)
            if (priceHistory.length >= 30) priceHistory.shift();
            priceHistory.push(price);
            priceChart.data.datasets[0].data = [...priceHistory, ...Array(30-priceHistory.length).fill(null)];
            priceChart.update();
        }

        // æ ¸å¿ƒ: æ‰§è¡Œä¸€å¤©æ¨¡æ‹Ÿ (æŒ‰é¡ºåºå¤„ç†äº‹ä»¶)
        function simulateDay(buyAmount, unstakePct) {
            // buyAmount: å¤–éƒ¨å‡€ä¹°å…¥USDT (å¯ä¸ºè´Ÿï¼Œè¡¨ç¤ºå–å‡º)
            // unstakePct: ç”¨æˆ·è§£è´¨æŠ¼æ¯”ä¾‹ (å H_stakedçš„ç™¾åˆ†æ¯”ï¼Œç„¶åå…¨éƒ¨å–å‡º)

            // 1. å¤„ç†å¤–éƒ¨ä¹°å– (buyAmount)
            if (Math.abs(buyAmount) > 0.01) {
                if (buyAmount > 0) {
                    // ä¹°å…¥: ç”¨ buyAmount U ä»æ± å­ä¹° H
                    let newU = U_lp + buyAmount;
                    let newH = k / newU;
                    let hOut = H_lp - newH;   // æ± å­å‡å°‘çš„Hï¼Œå³ç”¨æˆ·ä¹°å…¥çš„H
                    // ç”¨æˆ·ä¹°å…¥åï¼Œè¿™äº›Hç›´æ¥è¿›å…¥ç”¨æˆ·é’±åŒ…ï¼Œä»–ä»¬å¯ä»¥é€‰æ‹©è´¨æŠ¼ã€‚ä¸ºç®€åŒ–ï¼Œå‡è®¾ä»–ä»¬å…¨éƒ¨ç«‹å³è´¨æŠ¼ (å¤æŠ•)
                    H_lp = newH;
                    U_lp = newU;
                    // ç”¨æˆ·è·å¾— hOut ä¸ªHï¼Œå…¨éƒ¨è´¨æŠ¼
                    H_staked += hOut;
                    // äº¤æ˜“é‡ = buyAmount
                    let volume = buyAmount;
                    // ç¨è´¹ & è¿”ä½£
                    let tax = volume * 0.05;
                    let rebate = volume * 0.0034;
                    treasury += tax + rebate;
                } else {
                    // å–å‡º: ç”¨æˆ·å–å‡º H (ä»æ± å­æ¢U) ï¼Œå–å‡ºé‡ = å¯¹åº”USDTçš„è´Ÿå€¼ï¼Ÿå¤æ‚ã€‚æˆ‘ä»¬ç»Ÿä¸€ç”¨å–å‡ºUSDTä»·å€¼é‡æ¥ç®—ã€‚
                    // è‹¥ buyAmount = -20000ï¼Œè¡¨ç¤ºç”¨æˆ·æƒ³è¦å–å‡ºä»·å€¼20000Uçš„Hã€‚éœ€è¦è®¡ç®—éœ€è¦å–å‡ºå¤šå°‘Hã€‚
                    let sellU = -buyAmount;  // æœŸæœ›æ¢å¾—çš„USDT
                    // æ ¹æ®æ’å®šä¹˜ç§¯ï¼Œå–å‡º Î”H å¾—åˆ° Î”Uï¼Œæ»¡è¶³ (H_lp+Î”H)*(U_lp-Î”U)=kï¼Œä¸” Î”U â‰ˆ (Î”H * U_lp / H_lp) ä½†ç²¾ç¡®è§£ï¼š
                    // å®é™…ä¸Šå–å‡ºÎ”Hï¼Œæ–°U = k/(H_lp+Î”H)ï¼Œæ‰€ä»¥å¾—åˆ°çš„U = U_lp - k/(H_lp+Î”H) = æˆ‘ä»¬è¦æ±‚è¿™ä¸ªå€¼ = sellU
                    // è§£æ–¹ç¨‹: U_lp - k/(H_lp+Î”H) = sellU  => k/(H_lp+Î”H) = U_lp - sellU  => H_lp+Î”H = k/(U_lp - sellU)
                    // æ‰€ä»¥ Î”H = k/(U_lp - sellU) - H_lp
                    if (sellU >= U_lp) sellU = U_lp * 0.999; // é˜²æ­¢æŠ½å¹²æ± å­
                    let newU = U_lp - sellU;
                    let newH = k / newU;
                    let deltaH = newH - H_lp;  // å¢åŠ çš„H (ç”¨æˆ·å–å‡ºçš„)
                    H_lp = newH;
                    U_lp = newU;
                    // è¿™äº›Hæ¥è‡ªç”¨æˆ·ï¼Œå‡è®¾æ¥è‡ªè´¨æŠ¼ç”¨æˆ·è§£è´¨æŠ¼ï¼Œä½†æ­¤å¤„å¤–éƒ¨å–å‡ºæˆ‘ä»¬å•ç‹¬å¤„ç†ï¼šå¯èƒ½æ˜¯éè´¨æŠ¼ç”¨æˆ·å–å‡ºã€‚æˆ‘ä»¬ç»Ÿä¸€ä»H_stakedä¸­æ‰£é™¤?
                    // ä¸ºç®€å•ï¼Œæˆ‘ä»¬å‡è®¾å¤–éƒ¨å–å‡ºå°±æ˜¯ç›´æ¥ä»H_stakedä¸­å–å‡ºå–å‡º(å³è§£è´¨æŠ¼çš„ä¸€éƒ¨åˆ†)ã€‚æˆ‘ä»¬å°†åœ¨åç»­ç»Ÿä¸€å¤„ç†è§£è´¨æŠ¼ã€‚
                    // ä½†ä¸ºäº†é¿å…é‡å¤ï¼Œè¿™é‡Œå¤–éƒ¨å–å‡ºæˆ‘ä»¬å‡å®šæ¥è‡ªå¸‚åœºæŠ•æœºè€…ï¼Œä¸ä»H_stakedå‡ã€‚æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¸´æ—¶å˜é‡ "market_sell" æ¥è‡ªå¤–éƒ¨éè´¨æŠ¼ç­¹ç ? ä½†åˆæœŸå¤–éƒ¨æŒå¸å°‘ï¼Œæ‰€ä»¥å¯ä»¥å¿½ç•¥ã€‚
                    // æ›´åˆç†ï¼šæˆ‘ä»¬å°†å¤–éƒ¨å–å‡ºè§†ä¸ºæ¥è‡ªéè´¨æŠ¼ç”¨æˆ·ï¼ˆæ¯”å¦‚ç¤¾åŒºæ—©æœŸæŒä»“å–å‡ºï¼‰ï¼Œä½†æˆ‘ä»¬æœ‰ç¤¾åŒº5äº¿Hä½œä¸ºæˆ˜ç•¥å‚¨å¤‡ï¼Œæš‚ä¸å–å‡ºã€‚æ‰€ä»¥æš‚å®šå¤–éƒ¨å–å‡ºä¸º0ã€‚
                    // ä¸ºäº†æ¨¡å‹ç®€æ´ï¼Œæˆ‘ä»¬é™åˆ¶buyAmountä¸èƒ½ä¸ºè´Ÿï¼ˆå¤–éƒ¨å‡€å–å‡ºè®¾ä¸º0ï¼‰ï¼Œæˆ–è€…å¦‚æœç”¨æˆ·æƒ³æµ‹è¯•å–å‡ºï¼Œå¯ç”¨è§£è´¨æŠ¼æ¯”ä¾‹ã€‚
                    // æˆ‘ä»¬é‡æ–°å®šä¹‰ï¼šbuyAmountä»…è¡¨ç¤ºå¤–éƒ¨æ–°èµ„é‡‘ä¹°å…¥ï¼ˆæ­£ï¼‰ã€‚å–å‡ºå®Œå…¨ç”±è§£è´¨æŠ¼æ¯”ä¾‹æ§åˆ¶ã€‚è¿™æ ·æ›´å¹²å‡€ã€‚
                    // æ‰€ä»¥å¦‚æœbuyAmountä¸ºè´Ÿï¼Œæˆ‘ä»¬å¿½ç•¥ï¼ˆè®¾ä¸º0ï¼‰ã€‚
                    buyAmount = 0;
                }
            }

            // 1b. å¤„ç†è§£è´¨æŠ¼å–å‡º (æŒ‰æ¯”ä¾‹)
            if (unstakePct > 0 && H_staked > 0) {
                let sellH = H_staked * (unstakePct / 100);
                // è¿™äº›Hå…¨éƒ¨å–å‡º
                // æ± å­å˜åŒ–: H_lp += sellH, U_lp å‡å°‘
                let newH = H_lp + sellH;
                let newU = k / newH;  // æ–°Uå€¼
                let receivedU = U_lp - newU; // ç”¨æˆ·å–å‡ºå¾—åˆ°çš„U (å®é™…è¿›å…¥ç”¨æˆ·å£è¢‹ï¼Œæˆ‘ä»¬ä¸è€ƒè™‘å†æŠ•èµ„)
                // æ›´æ–°æ± å­
                H_lp = newH;
                U_lp = newU;
                // å‡å°‘è´¨æŠ¼é‡
                H_staked -= sellH;
                // äº¤æ˜“é‡ = receivedU (ç”¨æˆ·å¾—åˆ°çš„U) è¿‘ä¼¼? å®é™…å–å‡ºäº¤æ˜“é‡ä»¥USDTè®¡ä¸º receivedU
                let volume = receivedU;
                let tax = volume * 0.05;
                let rebate = volume * 0.0034;
                treasury += tax + rebate;
            }

            // 2. çº¢çº¿æ£€æŸ¥ & ç¤¾åŒºå›è´­
            let price = U_lp / H_lp;
            letå›è´­æ‰§è¡Œæ¬¡æ•° = 0;
            while (price <= PRICE_REDLINE && communityU > 0.01) {
                // ç¤¾åŒºé’±åŒ…ä¹°å…¥ï¼Œç›´åˆ°ä»·æ ¼ > 0.006 æˆ– é’±èŠ±å®Œ
                // æˆ‘ä»¬éœ€è¦è®¡ç®—éœ€è¦ä¹°å…¥å¤šå°‘Uæ‰èƒ½æŠŠä»·æ ¼æ¨é«˜åˆ° 0.006 ä»¥ä¸Šã€‚è®¾ç›®æ ‡ä»·æ ¼ P_target = PRICE_REDLINE + 0.0001 (ç•¥é«˜)
                let targetPrice = PRICE_REDLINE * 1.02; // è®¾ç›®æ ‡ä¸º 0.00612ï¼Œé¿å…é¢‘ç¹è§¦å‘
                // å½“å‰ k ä¸å˜ï¼Œä½†ç¤¾åŒºä¹°å…¥ä¼šå¢åŠ  U_lp, å‡å°‘ H_lp
                // æˆ‘ä»¬éœ€è¦æ‰¾åˆ°ä¹°å…¥ Î”U åï¼Œæ–°ä»·æ ¼ = (U_lp+Î”U) / (k/(U_lp+Î”U)) = (U_lp+Î”U)^2 / k
                // è®¾ç›®æ ‡ä»·æ ¼ P_targetï¼Œåˆ™ (U_lp+Î”U)^2 / k = P_target => U_lp+Î”U = sqrt(P_target * k) => Î”U = sqrt(P_target * k) - U_lp
                let sqrtTarget = Math.sqrt(targetPrice * k);
                let neededU = sqrtTarget - U_lp;
                if (neededU <= 0) break; // ä»·æ ¼å·²è¾¾æ ‡
                // å®é™…å¯ç”¨çš„U
                let buyU = Math.min(neededU, communityU);
                if (buyU <= 0) break;
                // æ‰§è¡Œå›è´­
                let newU = U_lp + buyU;
                let newH = k / newU;
                let hBought = H_lp - newH; // ç¤¾åŒºä¹°å…¥çš„Hæ•°é‡
                H_lp = newH;
                U_lp = newU;
                communityU -= buyU;
                communityH += hBought; // å›è´­çš„Hè¿›å…¥ç¤¾åŒºé’±åŒ…
                // å›è´­æœ¬èº«äº§ç”Ÿäº¤æ˜“é‡ buyUï¼Œä½†ç¤¾åŒºå›è´­ä¸è®¡å…¥ç¨è´¹ï¼Ÿæˆ‘ä»¬å‡è®¾å›è´­ä¸æ”¶ç¨ï¼ˆæˆ–è€…æ”¶ç¨ä¹Ÿæ— å¦¨ï¼Œä½†ç®€åŒ–ä¸è®¡ï¼‰
                // è¿™é‡Œä¸ºäº†ä¸¥è°¨ï¼Œå¦‚æœå›è´­è¦äº¤ç¨ï¼Œä¼šå‡å°‘Uï¼Œä½†ç¤¾åŒºå¤šç­¾å¯ä»¥è®¾ç½®å…ç¨ã€‚æˆ‘ä»¬æš‚å®šå›è´­ä¸æ”¶ç¨ã€‚
                triggerCount++;
                å›è´­æ‰§è¡Œæ¬¡æ•°++;
                price = U_lp / H_lp; // é‡æ–°è®¡ç®—ä»·æ ¼
                if (å›è´­æ‰§è¡Œæ¬¡æ•° > 10) break; // é˜²æ­¢æ— é™å¾ªç¯
            }

            // 3. æ¯æ—¥æ”¶ç›Šå‘æ”¾ (ä»æ”¶ç›Šå‚¨å¤‡åˆ°è´¨æŠ¼ç”¨æˆ·ï¼Œè‡ªåŠ¨å¤æŠ•)
            price = U_lp / H_lp;
            let payoutH = DAILY_PAYOUT_USD / price;
            if (payoutH > H_reward) payoutH = H_reward; // æ”¶ç›Šå‚¨å¤‡ä¸å¤Ÿå°±å…¨å‘
            H_reward -= payoutH;
            H_staked += payoutH;  // å¤æŠ•

            // 4. å›½åº“ç´¯ç§¯åˆ°1000Uè‡ªåŠ¨è½¬è´¦/å›è´­
            while (treasury >= 1000) {
                // 300U å›è´­
                let buyU = 300;
                let newU = U_lp + buyU;
                let newH = k / newU;
                let hBought = H_lp - newH;
                H_lp = newH;
                U_lp = newU;
                // å›½åº“å‡å°‘300
                treasury -= 300;
                // 700U è½¬ç¤¾åŒºé’±åŒ…
                communityU += 700;
                // äº¤æ˜“é‡ buyUï¼Œä½†è½¬è´¦éƒ¨åˆ†ä¸ç®—äº¤æ˜“é‡ï¼Œå›è´­äº¤æ˜“é‡è®¡å…¥ç¨è´¹ï¼Ÿä½†è¿™é‡Œå›è´­ç”¨å›½åº“Uï¼Œå¦‚æœæ”¶ç¨ä¼šå¾ªç¯ï¼Œæˆ‘ä»¬å‡è®¾å›½åº“å›è´­ä¹Ÿä¸æ”¶ç¨ã€‚
                // ä¸ºäº†ç®€å•ï¼Œè¿™æ¬¡å›è´­ä¸äº§ç”Ÿé¢å¤–ç¨è´¹ã€‚
                // ä½†å¯è®°å½•è§¦å‘
                // æ³¨æ„ï¼šä»·æ ¼å¯èƒ½ä¼šå› æ­¤å˜åŠ¨
                price = U_lp / H_lp;
                // æ£€æŸ¥çº¢çº¿ (å¦‚æœå›è´­åä»·æ ¼è·Œç ´çº¢çº¿ï¼Œå¯èƒ½è§¦å‘ç¤¾åŒºé’±åŒ…é¢å¤–å›è´­ï¼Œä½†æˆ‘ä»¬å·²åœ¨æ­¥éª¤2å¤„ç†ï¼Œä½†æ­¥éª¤2åœ¨ä¹‹å‰ï¼Œé¡ºåºé—®é¢˜ã€‚æˆ‘ä»¬é‡æ–°è°ƒç”¨çº¢çº¿æ£€æŸ¥ï¼Ÿ
                // æœ€å¥½åœ¨æœ€åç»Ÿä¸€å†æ£€æŸ¥ä¸€æ¬¡çº¢çº¿ã€‚ä½†ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬åœ¨æ¯ä¸ªæ”¹å˜ä»·æ ¼çš„æ“ä½œåé‡æ–°è®¡ç®—ï¼Œå¹¶å¯èƒ½è§¦å‘æ­¥éª¤2ã€‚
            }

            // æœ€åå†æ¬¡æ£€æŸ¥çº¢çº¿ (å› ä¸ºå›½åº“å›è´­å¯èƒ½ä½¿ä»·æ ¼å˜åŒ–)
            price = U_lp / H_lp;
            let loopGuard = 0;
            while (price <= PRICE_REDLINE && communityU > 0.01 && loopGuard < 10) {
                let targetPrice = PRICE_REDLINE * 1.02;
                let sqrtTarget = Math.sqrt(targetPrice * k);
                let neededU = sqrtTarget - U_lp;
                if (neededU <= 0) break;
                let buyU = Math.min(neededU, communityU);
                if (buyU <= 0) break;
                let newU = U_lp + buyU;
                let newH = k / newU;
                let hBought = H_lp - newH;
                H_lp = newH;
                U_lp = newU;
                communityU -= buyU;
                communityH += hBought;
                triggerCount++;
                price = U_lp / H_lp;
                loopGuard++;
            }

            // å¢åŠ å¤©æ•°
            day++;
        }

        // é‡ç½®åˆå§‹çŠ¶æ€
        function reset() {
            H_lp = 9523809.52;
            U_lp = 210000;
            H_staked = 8660000;
            H_reward = 300000000;
            treasury = 5340;
            communityU = 20000;
            communityH = 500000000;
            day = 0;
            triggerCount = 0;
            priceHistory = [];
            priceHistory.push(U_lp / H_lp);
            updateDisplay();
        }

        // äº‹ä»¶ç›‘å¬
        stepBtn.addEventListener('click', function() {
            let buyVal = parseFloat(buyInput.value);
            let unstakeVal = parseFloat(unstakeInput.value);
            buyInLabel.innerText = buyVal;
            unstakeLabel.innerText = unstakeVal + '%';
            simulateDay(buyVal, unstakeVal);
            updateDisplay();
        });

        resetBtn.addEventListener('click', function() {
            reset();
        });

        // æ»‘å—å®æ—¶æ˜¾ç¤º
        buyInput.addEventListener('input', function() {
            buyInLabel.innerText = buyInput.value;
        });
        unstakeInput.addEventListener('input', function() {
            unstakeLabel.innerText = unstakeInput.value + '%';
        });

        // åˆå§‹åŒ–
        reset();

        // ä¿®æ­£åˆå§‹ä»·æ ¼å†å²
        priceHistory = [U_lp / H_lp];
        updateDisplay();
    })();
</script>
</body>
</html>